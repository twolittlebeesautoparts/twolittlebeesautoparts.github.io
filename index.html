<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Two Little Bees – Inventory</title>

<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#0b0f14">
<meta name="description" content="Two Little Bees Auto Parts inventory — VIN-verified OEM used parts in Indianapolis.">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#101826;
  --panel-soft:#0f172a;
  --card:#0d1626;
  --accent:#f4c430;
  --accent2:#ffb703;
  --text:#f9fafb;
  --muted:#9ca3af;
  --danger:#ff4d4d;
  --ok:#22c55e;
  --warn:#f59e0b;
  --border:rgba(255,255,255,.10);
  --shadow:0 30px 70px rgba(0,0,0,.60);
  --radius:18px;
  --radius2:14px;
  --glass:rgba(11,15,20,.72);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
html,body{width:100%;max-width:100%;overflow-x:hidden}
a{color:inherit;text-decoration:none}
::selection{background:rgba(244,196,48,.22)}

body{
  background:
    radial-gradient(1000px 600px at 15% -10%, rgba(244,196,48,.16), transparent 60%),
    radial-gradient(1000px 600px at 90% 0%, rgba(255,183,3,.12), transparent 60%),
    radial-gradient(900px 500px at 40% 115%, rgba(31,41,55,.28), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 22%),
    var(--bg);
  color:var(--text);
  padding-left:env(safe-area-inset-left);
  padding-right:env(safe-area-inset-right);
  padding-bottom:calc(env(safe-area-inset-bottom) + 18px);
  -webkit-font-smoothing:antialiased;
}

@media (prefers-reduced-motion:no-preference){
  .lift{transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
  .lift:hover{transform:translateY(-2px); box-shadow:0 40px 85px rgba(0,0,0,.62); border-color:rgba(244,196,48,.30)}
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(11,15,20,.88);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,.08);
}

.header-inner{
  max-width:1200px;
  margin:auto;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  flex-wrap:wrap;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:240px;
}

.logo{
  width:64px;
  height:64px;
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  border-radius:0;
  object-fit:contain;
  display:block;
  cursor:pointer;
  image-rendering:auto;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,.45));
}

@media(max-width:700px){
  .logo{ width:58px; height:58px; }
}

.titleWrap h2{
  font-size:1.05rem;
  letter-spacing:.2px;
  font-weight:950;
}
.titleWrap .sub{
  color:var(--muted);
  font-size:.85rem;
  margin-top:2px;
}

.header-actions{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.pill{
  text-decoration:none;
  font-weight:950;
  padding:9px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  background:rgba(15,23,42,.55);
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

.pill.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;
  border:none;
}
.pill:active{transform:scale(.99)}

/* MAIN */
main{
  max-width:1200px;
  margin:auto;
  padding:22px 16px 42px;
}

/* CARD */
.card{
  background:
    radial-gradient(700px 280px at 0% 0%, rgba(244,196,48,.09), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
    var(--panel);
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow);
  margin-bottom:18px;
}

.cardHead{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

.card h3{font-size:1.05rem; font-weight:950}
.mini{
  color:var(--muted);
  font-size:.85rem;
  font-weight:800;
}

hr.sep{
  border:none;
  height:1px;
  background:rgba(255,255,255,.10);
  margin:14px 0;
}

/* FORMS */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
}

input,button,select,textarea{
  background:#0f1422;
  color:#fff;
  border:1px solid rgba(255,255,255,.15);
  padding:12px;
  border-radius:var(--radius2);
  outline:none;
}

textarea{min-height:44px; resize:vertical}
input::placeholder, textarea::placeholder{color:rgba(156,163,175,.85)}

input:focus,select:focus,textarea:focus{
  border-color:rgba(244,196,48,.65);
  box-shadow:0 0 0 4px rgba(244,196,48,.14);
}

button{cursor:pointer;font-weight:950}
button[disabled]{opacity:.6;cursor:not-allowed}

button.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;
  border:none;
}

button.danger{
  background:var(--danger);
  border:none;
  color:#000;
}

button.ghost{
  background:rgba(255,255,255,.06);
}

.note{
  margin-top:10px;
  font-size:12px;
  min-height:18px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
}
.note .dot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,.18);
  box-shadow:0 0 0 3px rgba(255,255,255,.06);
}
.note.ok{color:var(--ok)}
.note.ok .dot{background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.18)}
.note.bad{color:var(--danger)}
.note.bad .dot{background:var(--danger);box-shadow:0 0 0 3px rgba(255,77,77,.18)}
.note.warn{color:var(--warn)}
.note.warn .dot{background:var(--warn);box-shadow:0 0 0 3px rgba(245,158,11,.18)}

/* FILTER BAR */
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}
.toolbar input{ flex:1 1 260px; }

.smallHint{
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
}
.pulseDot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(244,196,48,.85);
  box-shadow:0 0 0 6px rgba(244,196,48,.12);
}

/* TABLE */
.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  max-height:560px;
  overflow-y:auto;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(15,23,42,.16);

  -ms-overflow-style:none;
  scrollbar-width:none;
}
.table-wrap::-webkit-scrollbar{width:0;height:0;display:none}

table{
  width:100%;
  min-width:880px;
  border-collapse:collapse;
  margin-top:12px;
}

table thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:rgba(11,15,20,.96);
  backdrop-filter:blur(10px);
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  vertical-align:top;
}

th{
  color:var(--accent);
  font-weight:950;
  font-size:.9rem;
}

td strong{font-weight:950}

.specs{
  font-size:13px;
  color:var(--muted);
  margin-top:4px;
  line-height:1.35;
}

.kv{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}
.tag{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  background:rgba(15,23,42,.55);
  font-weight:900;
}

.tag.ok{
  border-color: rgba(34,197,94,.35);
  background: rgba(34,197,94,.10);
}
.tag.bad{
  border-color: rgba(255,77,77,.35);
  background: rgba(255,77,77,.10);
}
.tag.miles{
  border-color: rgba(244,196,48,.35);
  background: rgba(244,196,48,.10);
  color:#fff;
}
.tag.stock{
  border-color: rgba(244,196,48,.35);
  background: rgba(244,196,48,.08);
}

/* Small action buttons in table */
.smallBtn{
  padding:9px 10px;
  border-radius:12px;
  font-weight:950;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
}
.smallBtn:active{transform:scale(.99)}
.smallBtn.danger{background:var(--danger);border:none;color:#000}
.smallBtn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;border:none}

/* ADMIN VISIBILITY */
.admin-only{ display:none; }
body.is-admin .admin-flex{ display:inline-flex; }
body.is-admin .admin-block{ display:block; }
body.is-admin th.admin-cell,
body.is-admin td.admin-cell{ display:table-cell; }

/* TOAST */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(env(safe-area-inset-bottom) + 14px);
  background:rgba(15,23,42,.92);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  border-radius:12px;
  font-size:12px;
  color:var(--text);
  display:none;
  z-index:9999;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}

/* MODAL */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  z-index:9998;
  padding:18px;
}
.modal{
  max-width:920px;
  margin:6vh auto 0;
  background:
    radial-gradient(700px 300px at 0% 0%, rgba(244,196,48,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
    var(--panel);
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.modalHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
.modalHead h3{ font-size:1.05rem; font-weight:950 }
.modalActions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}
.xBtn{
  width:42px;height:42px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:950;
  cursor:pointer;
}

/* ✅ Photo square scroller */
.gallery{
  display:flex;
  align-items:flex-start;
  gap:12px;
}

.photoSquare{
  width:112px;
  height:112px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120px 120px at 30% 20%, rgba(244,196,48,.14), transparent 60%),
    rgba(255,255,255,.04);
  overflow:hidden;
  position:relative;
  flex:0 0 auto;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
}

.photoTrack{
  width:100%;
  height:100%;
  display:flex;
  overflow-x:auto;
  overflow-y:hidden;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  touch-action:pan-x;
  cursor:grab;
}
.photoTrack:active{ cursor:grabbing; }

.photoTrack::-webkit-scrollbar{display:none}
.photoTrack img{
  width:112px;
  height:112px;
  object-fit:cover;
  flex:0 0 auto;
  scroll-snap-align:start;
  user-select:none;
  -webkit-user-drag:none;
  pointer-events:auto;
  cursor:pointer;
}

.photoFallback{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:rgba(156,163,175,.95);
  font-weight:950;
  font-size:12px;
  letter-spacing:.2px;
}

.photoBadge{
  position:absolute;
  top:8px;
  left:8px;
  padding:6px 8px;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.14);
  font-size:11px;
  font-weight:950;
  color:#fff;
  backdrop-filter:blur(8px);
  display:none;
  pointer-events:none;
}
.photoSquare.hasPhotos .photoBadge{display:inline-block}
.photoBadge span{color:rgba(244,196,48,.95)}

.copyLine{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* PHOTO VIEWER */
.photoViewer{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.photoViewerTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.photoViewerImgWrap{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  background:rgba(255,255,255,.04);
  max-height:70vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
#photoView{
  max-width:100%;
  max-height:70vh;
  object-fit:contain;
  display:block;
}
.photoViewerNav{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* PARTS */
.partsWrap{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  overflow:hidden;
  background:rgba(15,23,42,.18);
}
.partsHeader{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.partsHeader .mini{margin:0}
.partsTable{
  width:100%;
  border-collapse:collapse;
}
.partsTable th, .partsTable td{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.partsTable th{
  color:var(--accent);
  font-size:.85rem;
  text-align:left;
}
.partsTable td{
  font-size:.92rem;
}
.partsTools{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.badgeQty{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-weight:950;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.badgeQty span{ color: rgba(244,196,48,.95); }

.money{ font-weight:950; }
.muted{ color:var(--muted); font-size:12px; }

/* ✅ MOBILE: stack as cards */
@media(max-width:700px){
  html,body{ overflow-x:hidden; }

  .table-wrap{
    overflow-x:hidden;
    max-height:none;
    border:0;
    background:transparent;
    padding:0;
  }

  table{ min-width:0 !important; width:100%; margin-top:12px; }
  thead{ display:none; }
  tbody, tr, td{ display:block; width:100%; }

  tr{
    background:rgba(15,23,42,.35);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    margin:12px 0;
  }

  td{ border:none; padding:0; }
  td + td{ margin-top:12px; }
  body.is-admin td.admin-cell{ display:block; }

  .photoSquare{ width:104px; height:104px; }
  .photoTrack img{ width:104px; height:104px; }

  .partsHeader{ gap:12px; }
  .partsTable thead{ display:none; }
  .partsTable, .partsTable tbody, .partsTable tr, .partsTable td{ display:block; width:100%; }
  .partsTable tr{ border-bottom:1px solid rgba(255,255,255,.10); padding:10px 12px; }
  .partsTable td{ border:none; padding:6px 0; }
}
</style>
</head>

<body>

<div class="toast" id="toast">Copied</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <img
        src="https://github.com/twolittlebeesautoparts/twolittlebeesautoparts.github.io/blob/main/new.logo@2x.png%20(2000%E2%80%933000px%20wide).png?raw=true"
        class="logo"
        alt="Two Little Bees Auto Parts Logo"
        onclick="beeSecret()"
      />
      <div class="titleWrap">
        <h2>Inventory</h2>
        <div class="sub">Live list • VIN-verified • Indianapolis</div>
      </div>
    </div>

    <div class="header-actions">
      <a class="pill" href="https://twolittlebeesautoparts.github.io/OFFICIALPAGE/">Home</a>
      <a class="pill primary" href="https://twolittlebeesautoparts.github.io/">Search Inventory</a>
      <a class="pill admin-only admin-flex" href="javascript:void(0)" onclick="logout()">Logout</a>
    </div>
  </div>
</header>

<main>

  <!-- LOGIN (hidden until secret tap) -->
  <div class="card lift" id="loginCard" style="display:none">
    <div class="cardHead">
      <div>
        <h3>Admin Login</h3>
        <div class="mini">Tap logo 3 times to open this screen</div>
      </div>
    </div>
    <hr class="sep">
    <div class="grid">
      <input id="username" placeholder="Username" autocomplete="username">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
      <button class="primary" onclick="login()">Login</button>
    </div>
    <div id="loginMsg" class="note"><span class="dot"></span><span id="loginMsgText"></span></div>
  </div>

  <!-- INVENTORY -->
  <div class="card lift">
    <div class="cardHead">
      <div>
        <h3>Current Inventory</h3>
        <div class="mini" id="countLine">Loading…</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="smallHint"><span class="pulseDot"></span><span id="liveHint">Live sync on</span></div>
        <button class="smallBtn admin-only admin-flex" onclick="scrollToAdmin()">+ Add Vehicle</button>
      </div>
    </div>

    <div class="toolbar">
      <input id="search" placeholder="Search stock #, year, make, model, VIN, engine, mileage…" oninput="applyFilters()">
      <select id="sort" onchange="applyFilters()">
        <option value="newest">Sort: Newest</option>
        <option value="oldest">Sort: Oldest</option>
        <option value="yearDesc">Sort: Year (High → Low)</option>
        <option value="yearAsc">Sort: Year (Low → High)</option>
        <option value="makeAsc">Sort: Make (A → Z)</option>
        <option value="milesAsc">Sort: Mileage (Low → High)</option>
        <option value="milesDesc">Sort: Mileage (High → Low)</option>
      </select>
      <button class="smallBtn ghost" onclick="clearSearch()">Clear</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:58%">Vehicle</th>
            <th style="width:22%">VIN / Stock</th>
            <th style="width:20%" class="admin-only admin-cell">Actions</th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>
    </div>

    <div id="invMsg" class="note"><span class="dot"></span><span id="invMsgText"></span></div>
  </div>

  <!-- QUICK ADD PART BY STOCK -->
  <div class="card admin-only admin-block lift" id="quickPartsCard">
    <div class="cardHead">
      <div>
        <h3>Quick Add Parts (by Stock #)</h3>
        <div class="mini">Type the stock number → it finds the vehicle → add parts fast.</div>
      </div>
    </div>
    <hr class="sep">

    <div class="grid">
      <input id="qp_stock" placeholder="Stock # (ex: TLB-20260214-001)">
      <button class="ghost" onclick="quickFindStock()">Find Vehicle</button>

      <input id="qp_vehicle" placeholder="Vehicle (auto)" disabled>
      <input id="qp_partName" placeholder="Part Name (ex: Alternator)">
      <input id="qp_partType" placeholder="Part Type (ex: Engine / Body / Module)">
      <input id="qp_interchange" placeholder="Interchange # (optional)">
      <input id="qp_location" placeholder="Location (ex: Rack A-3)">
      <input id="qp_qty" placeholder="Qty (ex: 1)" inputmode="numeric">
      <input id="qp_price" placeholder="Price (ex: 150)" inputmode="decimal">
      <input id="qp_core" placeholder="Core (optional)" inputmode="decimal">
      <textarea id="qp_notes" placeholder="Notes (optional)"></textarea>

      <button class="primary" id="qp_addBtn" onclick="quickAddPart()">Add Part to Vehicle</button>
      <button class="ghost" onclick="quickClear()">Clear</button>
    </div>

    <div id="qpMsg" class="note"><span class="dot"></span><span id="qpMsgText"></span></div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card admin-only admin-block lift" id="adminPanel">
    <div class="cardHead">
      <div>
        <h3>Add Vehicle</h3>
        <div class="mini">Tip: paste VIN and it will auto-fill Year/Make/Model + more.</div>
      </div>
    </div>
    <hr class="sep">

    <div class="grid">
      <!-- ✅ Stock # -->
      <input id="stockNumber" placeholder="Stock # (auto)" disabled>
      <button class="ghost" type="button" onclick="generateStockToForm(false)">Generate Stock #</button>

      <input id="year" placeholder="Year (e.g. 2017)" inputmode="numeric">
      <input id="make" placeholder="Make (Brand)">
      <input id="model" placeholder="Model">
      <input id="mileage" placeholder="Mileage (e.g. 128000)" inputmode="numeric">

      <input id="vin" placeholder="VIN (17 chars)" maxlength="17">
      <button class="ghost" type="button" onclick="autoFillFromVIN(false)">Auto-Fill from VIN</button>

      <input id="color" placeholder="Color">
      <input id="engine" placeholder="Engine Size (e.g. 3.6L)">
      <input id="transmission" placeholder="Transmission (Auto / Manual / CVT)">
      <input id="drivetrain" placeholder="Drivetrain (FWD / RWD / AWD)">

      <select id="goodMotor">
        <option value="">Good Motor? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>
      <select id="goodTrans">
        <option value="">Good Transmission? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>

      <textarea id="photoUrls" placeholder="Photo URLs (comma-separated)&#10;Example: https://...1.jpg, https://...2.jpg"></textarea>

      <button class="primary" id="addBtn" onclick="addCar()">Add Vehicle</button>
    </div>

    <div id="adminMsg" class="note"><span class="dot"></span><span id="adminMsgText"></span></div>
  </div>

</main>

<footer style="border-top:1px solid rgba(255,255,255,.08);text-align:center;padding:22px 16px;color:var(--muted)">
  © 2026 Two Little Bees Auto Parts
</footer>

<!-- EDIT MODAL (admin) -->
<div class="modalBack admin-only" id="editBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>Edit Vehicle</h3>
        <div class="mini" id="editSub">Update details then hit Save.</div>
      </div>
      <button class="xBtn" onclick="closeEdit()">✕</button>
    </div>

    <hr class="sep">

    <div class="grid">
      <!-- ✅ Stock # -->
      <input id="e_stockNumber" placeholder="Stock # (auto)" disabled>
      <button class="ghost" type="button" onclick="generateStockToForm(true)">Generate Stock #</button>

      <input id="e_year" placeholder="Year (e.g. 2017)" inputmode="numeric">
      <input id="e_make" placeholder="Make (Brand)">
      <input id="e_model" placeholder="Model">
      <input id="e_mileage" placeholder="Mileage (e.g. 128000)" inputmode="numeric">

      <input id="e_vin" placeholder="VIN (17 chars)" maxlength="17">
      <button class="ghost" type="button" onclick="autoFillFromVIN(true)">Auto-Fill from VIN</button>

      <input id="e_color" placeholder="Color">
      <input id="e_engine" placeholder="Engine Size (e.g. 3.6L)">
      <input id="e_transmission" placeholder="Transmission (Auto / Manual / CVT)">
      <input id="e_drivetrain" placeholder="Drivetrain (FWD / RWD / AWD)">

      <select id="e_goodMotor">
        <option value="">Good Motor? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>
      <select id="e_goodTrans">
        <option value="">Good Transmission? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>

      <textarea id="e_photoUrls" placeholder="Photo URLs (comma-separated)"></textarea>
    </div>

    <div class="modalActions">
      <button class="primary" id="saveBtn" onclick="saveEdit()">Save Changes</button>
      <button class="ghost" onclick="closeEdit()">Cancel</button>
      <button class="smallBtn" onclick="openParts(editingId)" style="border-radius:12px">Parts</button>
      <button class="danger" onclick="deleteFromEdit()">Delete</button>
    </div>

    <div id="editMsg" class="note"><span class="dot"></span><span id="editMsgText"></span></div>
  </div>
</div>

<!-- PARTS MODAL (admin) -->
<div class="modalBack admin-only" id="partsBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>Vehicle Parts</h3>
        <div class="mini" id="partsSub">—</div>
      </div>
      <button class="xBtn" onclick="closeParts()">✕</button>
    </div>

    <hr class="sep">

    <div class="grid">
      <input id="p_partName" placeholder="Part Name (ex: Alternator)">
      <input id="p_partType" placeholder="Part Type (ex: Engine / Body / Module)">
      <input id="p_interchange" placeholder="Interchange # (optional)">
      <input id="p_location" placeholder="Location (ex: Rack A-3)">
      <input id="p_qty" placeholder="Qty (ex: 1)" inputmode="numeric">
      <input id="p_price" placeholder="Price (ex: 150)" inputmode="decimal">
      <input id="p_core" placeholder="Core (optional)" inputmode="decimal">
      <textarea id="p_notes" placeholder="Notes (optional)"></textarea>

      <button class="primary" id="p_saveBtn" onclick="savePart()">Save Part</button>
      <button class="ghost" onclick="resetPartForm()">New Part</button>
    </div>

    <div class="note" id="partsMsg"><span class="dot"></span><span id="partsMsgText"></span></div>

    <div style="height:12px"></div>

    <div class="partsWrap">
      <div class="partsHeader">
        <div>
          <div class="mini" id="partsCount">0 parts</div>
          <div class="muted">Tip: keep adding parts here — they stay synced to this stock #.</div>
        </div>
        <div class="partsTools">
          <button class="smallBtn ghost" onclick="refreshParts()">Refresh</button>
          <button class="smallBtn" onclick="copyPartsCSV()">Copy CSV</button>
        </div>
      </div>

      <div style="max-height:420px; overflow:auto; -webkit-overflow-scrolling:touch">
        <table class="partsTable">
          <thead>
            <tr>
              <th style="width:34%">Part</th>
              <th style="width:14%">Qty</th>
              <th style="width:14%">Price</th>
              <th style="width:14%">Core</th>
              <th style="width:24%">Actions</th>
            </tr>
          </thead>
          <tbody id="partsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- PHOTO VIEWER (anyone can use) -->
<div class="modalBack" id="photoBack">
  <div class="modal">
    <div class="photoViewer">
      <div class="photoViewerTop">
        <div>
          <h3 style="font-size:1.05rem;font-weight:950">Photo Viewer</h3>
          <div class="mini" id="photoSub">—</div>
        </div>
        <button class="xBtn" onclick="closePhoto()">✕</button>
      </div>

      <div class="photoViewerImgWrap">
        <img id="photoView" alt="Vehicle photo">
      </div>

      <div class="photoViewerNav">
        <button class="smallBtn ghost" onclick="prevPhoto()">◀ Prev</button>
        <button class="smallBtn ghost" onclick="nextPhoto()">Next ▶</button>
        <button class="smallBtn" onclick="openPhotoInNewTab()">Open in new tab</button>
        <button class="smallBtn ghost" onclick="copyCurrentPhotoUrl()">Copy URL</button>
      </div>

      <div class="note" id="photoMsg"><span class="dot"></span><span id="photoMsgText"></span></div>
    </div>
  </div>
</div>

<script>
/* ======================
   SECURITY NOTE (IMPORTANT)
   ======================
   This page uses a front-end username/password to show/hide admin UI.
   Anyone can view the code and see ADMIN_USER / ADMIN_PASS.
   Real protection must be done with Firebase Auth + Firestore security rules.
====================== */

/* ADMIN LOGIN */
const ADMIN_USER="admin";
const ADMIN_PASS="bees123";

let isAdmin=false;
let beeClicks=0;

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyBQ5WyWulY-MPb9Wlv144AwjjcS-JZt9k",
  authDomain:"two-little-bees-inventory.firebaseapp.com",
  projectId:"two-little-bees-inventory"
});

const db=firebase.firestore();
const ref=db.collection("inventory");
const metaRef=db.collection("meta").doc("stockCounter"); // ✅ used for unique stock numbers

/* UI refs */
const loginCard = document.getElementById("loginCard");
const adminPanel = document.getElementById("adminPanel");
const inventoryBody = document.getElementById("inventoryBody");

const loginMsg = document.getElementById("loginMsg");
const loginMsgText = document.getElementById("loginMsgText");

const invMsg = document.getElementById("invMsg");
const invMsgText = document.getElementById("invMsgText");

const adminMsg = document.getElementById("adminMsg");
const adminMsgText = document.getElementById("adminMsgText");

const countLine = document.getElementById("countLine");
const toast = document.getElementById("toast");
const liveHint = document.getElementById("liveHint");

/* Filters */
const searchEl = document.getElementById("search");
const sortEl = document.getElementById("sort");

let liveCars = [];   // [{id, ...data}]
let unsub = null;

/* EDIT MODAL refs */
const editBack = document.getElementById("editBack");
const editMsg = document.getElementById("editMsg");
const editMsgText = document.getElementById("editMsgText");
let editingId = null;

/* PHOTO VIEWER refs */
const photoBack = document.getElementById("photoBack");
const photoView = document.getElementById("photoView");
const photoSub = document.getElementById("photoSub");
const photoMsg = document.getElementById("photoMsg");
const photoMsgText = document.getElementById("photoMsgText");

let __photosByCarId = {}; // { id: [url,url] }
let __currentPhoto = { carId:null, idx:0 };

/* PARTS MODAL refs */
const partsBack = document.getElementById("partsBack");
const partsSub = document.getElementById("partsSub");
const partsBody = document.getElementById("partsBody");
const partsMsg = document.getElementById("partsMsg");
const partsMsgText = document.getElementById("partsMsgText");
const partsCount = document.getElementById("partsCount");

let __partsCarId = null;
let __partsUnsub = null;
let __partsList = []; // cached
let __editingPartId = null;

/* QUICK PARTS refs */
const qpMsg = document.getElementById("qpMsg");
const qpMsgText = document.getElementById("qpMsgText");
let __quickCarId = null;

/* ===== helpers ===== */
function setNote(el, textEl, msg, type=""){
  textEl.textContent = msg || "";
  el.className = "note" + (type ? " " + type : "");
}
function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.style.display="none", 950);
}
function escHtml(str){
  return String(str ?? "").replace(/[&<>"']/g,(m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function clean(str){ return String(str ?? "").trim(); }
function cleanVIN(v){ return clean(v).toUpperCase().replace(/[^A-Z0-9]/g,""); }
function validVIN(v){ return v.length === 17 && !/[IOQ]/.test(v); }

function ynToBool(v){
  if(v==="yes") return true;
  if(v==="no") return false;
  return null;
}
function boolToYN(b){
  if(b===true) return "yes";
  if(b===false) return "no";
  return "";
}

function parseMileage(v){
  const raw = clean(v).replace(/[^\d]/g,"");
  if(!raw) return null;
  const n = parseInt(raw, 10);
  return Number.isFinite(n) ? n : null;
}
function fmtMiles(n){
  if(n===null || n===undefined || n==="") return "";
  const num = typeof n === "number" ? n : parseMileage(String(n));
  if(num===null) return "";
  return num.toLocaleString() + " mi";
}

function parseMoney(v){
  const t = clean(v).replace(/[^0-9.]/g,"");
  if(!t) return null;
  const n = Number(t);
  return Number.isFinite(n) ? Math.round(n*100)/100 : null;
}
function fmtMoney(n){
  if(n===null || n===undefined) return "";
  const num = Number(n);
  if(!Number.isFinite(num)) return "";
  return "$" + num.toFixed(2);
}

function parseIntSafe(v, fallback=null){
  const t = clean(v).replace(/[^\d-]/g,"");
  if(!t) return fallback;
  const n = parseInt(t,10);
  return Number.isFinite(n) ? n : fallback;
}

function parsePhotoUrls(text){
  const t = clean(text);
  if(!t) return [];
  return t
    .split(",")
    .map(s=>clean(s))
    .filter(Boolean)
    .filter(u=>/^https?:\/\//i.test(u));
}

function setAdminUI(on){
  isAdmin = !!on;
  document.body.classList.toggle("is-admin", isAdmin);
  localStorage.setItem("tlb_admin", isAdmin ? "1" : "0");
  applyFilters();
}

/* ===== secret logo clicks ===== */
function beeSecret(){
  beeClicks++;
  if(beeClicks===3){
    loginCard.style.display="block";
    setNote(loginMsg, loginMsgText, "Enter credentials to enable admin tools.", "");
    beeClicks=0;
  }
  setTimeout(()=>beeClicks=0, 900);
}

/* ===== login/logout ===== */
function login(){
  const u = clean(username.value);
  const p = clean(password.value);

  if(u===ADMIN_USER && p===ADMIN_PASS){
    setAdminUI(true);
    loginCard.style.display="none";
    username.value = "";
    password.value = "";
    setNote(loginMsg, loginMsgText, "", "");
    showToast("Admin enabled");
  }else{
    setNote(loginMsg, loginMsgText, "Invalid login.", "bad");
  }
}

function logout(){
  setAdminUI(false);
  closeEdit();
  closeParts();
  showToast("Admin disabled");
}

/* =========================
   ✅ STOCK NUMBER (unique)
   =========================
   Format: TLB-YYYYMMDD-### (transaction safe)
*/
function pad3(n){ return String(n).padStart(3,"0"); }
function yyyymmdd(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}

async function nextStockNumber(){
  const today = yyyymmdd(new Date());

  // Transaction to avoid duplicate stock numbers
  const stock = await db.runTransaction(async (tx)=>{
    const snap = await tx.get(metaRef);
    let seq = 0;
    let date = today;

    if(!snap.exists){
      seq = 1;
      tx.set(metaRef, { date: today, seq: 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }else{
      const data = snap.data() || {};
      const oldDate = clean(data.date);
      const oldSeq = Number(data.seq || 0);

      if(oldDate === today){
        seq = oldSeq + 1;
        tx.update(metaRef, { seq, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }else{
        seq = 1;
        tx.update(metaRef, { date: today, seq: 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }

    return `TLB-${today}-${pad3(seq)}`;
  });

  return stock;
}

async function generateStockToForm(isEdit){
  const el = isEdit ? document.getElementById("e_stockNumber") : document.getElementById("stockNumber");
  const msgEl = isEdit ? editMsg : adminMsg;
  const msgTextEl = isEdit ? editMsgText : adminMsgText;

  try{
    setNote(msgEl, msgTextEl, "Generating Stock #…", "");
    const s = await nextStockNumber();
    el.value = s;
    setNote(msgEl, msgTextEl, `Stock # ready: ${s}`, "ok");
    showToast("Stock # generated");
  }catch(e){
    setNote(msgEl, msgTextEl, "Stock # generator failed (rules/connection).", "bad");
  }
}

/* =========================
   ✅ VIN AUTO-FILL (VPIC)
   ========================= */
async function decodeVIN(vin){
  const url = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${encodeURIComponent(vin)}?format=json`;
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("VIN lookup failed");
  const j = await r.json();
  const row = j && j.Results && j.Results[0] ? j.Results[0] : null;
  if(!row) throw new Error("No VIN data");

  const year = clean(row.ModelYear);
  const make = clean(row.Make);
  const model = clean(row.Model);

  let engine = "";
  const dispL = clean(row.DisplacementL);
  if(dispL && dispL !== "0") engine = `${dispL}L`;
  else engine = clean(row.EngineModel) || clean(row.EngineCylinders ? `${row.EngineCylinders} Cyl` : "");

  const transmission = clean(row.TransmissionStyle) || clean(row.TransmissionSpeeds ? `${row.TransmissionSpeeds}-Speed` : "");
  const drivetrain = clean(row.DriveType);

  return { year, make, model, engine, transmission, drivetrain, raw: row };
}

// fills either admin form or edit form
async function autoFillFromVIN(isEdit){
  const vinEl = isEdit ? document.getElementById("e_vin") : document.getElementById("vin");
  const v = cleanVIN(vinEl.value);

  const msgEl = isEdit ? editMsg : adminMsg;
  const msgTextEl = isEdit ? editMsgText : adminMsgText;

  if(!validVIN(v)){
    setNote(msgEl, msgTextEl, "VIN must be 17 chars (no I/O/Q) to auto-fill.", "warn");
    return;
  }

  setNote(msgEl, msgTextEl, "Decoding VIN…", "");
  try{
    const d = await decodeVIN(v);

    const yEl = isEdit ? e_year : year;
    const mkEl = isEdit ? e_make : make;
    const mdEl = isEdit ? e_model : model;
    const engEl = isEdit ? e_engine : engine;
    const trnEl = isEdit ? e_transmission : transmission;
    const drvEl = isEdit ? e_drivetrain : drivetrain;

    if(d.year) yEl.value = d.year;
    if(d.make) mkEl.value = d.make;
    if(d.model) mdEl.value = d.model;

    if(d.engine && !clean(engEl.value)) engEl.value = d.engine;
    if(d.transmission && !clean(trnEl.value)) trnEl.value = d.transmission;
    if(d.drivetrain && !clean(drvEl.value)) drvEl.value = d.drivetrain;

    setNote(msgEl, msgTextEl, `Auto-filled from VIN: ${[d.year,d.make,d.model].filter(Boolean).join(" ") || "done"}.`, "ok");
    showToast("VIN Auto-Fill");
  }catch(e){
    setNote(msgEl, msgTextEl, "VIN auto-fill failed. Try again (or the VIN may be invalid).", "bad");
  }
}

// auto-trigger when VIN reaches 17 chars
function hookVinAutoFill(){
  const vinInput = document.getElementById("vin");
  const eVinInput = document.getElementById("e_vin");

  vinInput.addEventListener("input", ()=>{
    const v = cleanVIN(vinInput.value);
    vinInput.value = v;
    if(v.length === 17 && validVIN(v)) autoFillFromVIN(false);
  });

  eVinInput.addEventListener("input", ()=>{
    const v = cleanVIN(eVinInput.value);
    eVinInput.value = v;
    if(v.length === 17 && validVIN(v)) autoFillFromVIN(true);
  });
}

/* =========================
   ✅ PHOTO CLICK + SCROLL FIX
   ========================= */
function enableDragScroll(el){
  let isDown=false, startX=0, startLeft=0;

  el.addEventListener("mousedown",(e)=>{
    isDown=true;
    startX=e.pageX;
    startLeft=el.scrollLeft;
    el.style.cursor="grabbing";
    e.preventDefault();
  });
  window.addEventListener("mouseup",()=>{
    if(!isDown) return;
    isDown=false;
    el.style.cursor="grab";
  });
  el.addEventListener("mouseleave",()=>{
    if(!isDown) return;
    isDown=false;
    el.style.cursor="grab";
  });
  el.addEventListener("mousemove",(e)=>{
    if(!isDown) return;
    const dx = e.pageX - startX;
    el.scrollLeft = startLeft - dx;
  });

  el.addEventListener("wheel",(e)=>{
    if(Math.abs(e.deltaX) > Math.abs(e.deltaY)) return;
    if(el.scrollWidth <= el.clientWidth) return;
    el.scrollLeft += e.deltaY;
    e.preventDefault();
  }, { passive:false });
}

function openPhoto(carId, idx){
  const arr = __photosByCarId[carId] || [];
  if(!arr.length) return;

  __currentPhoto.carId = carId;
  __currentPhoto.idx = Math.max(0, Math.min(idx, arr.length-1));

  photoBack.style.display = "block";
  setNote(photoMsg, photoMsgText, "Swipe on phone, or use Prev/Next.", "");
  renderPhoto();
}

function renderPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length){
    closePhoto();
    return;
  }
  const url = arr[__currentPhoto.idx];
  photoView.src = url;
  photoSub.textContent = `Photo ${__currentPhoto.idx+1} of ${arr.length}`;
}

function closePhoto(){
  photoBack.style.display = "none";
  photoView.src = "";
  __currentPhoto = { carId:null, idx:0 };
}

function nextPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  __currentPhoto.idx = (__currentPhoto.idx + 1) % arr.length;
  renderPhoto();
}
function prevPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  __currentPhoto.idx = (__currentPhoto.idx - 1 + arr.length) % arr.length;
  renderPhoto();
}
function openPhotoInNewTab(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  window.open(arr[__currentPhoto.idx], "_blank");
}
async function copyCurrentPhotoUrl(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  const url = arr[__currentPhoto.idx];
  await copyText(url);
  showToast("Photo URL copied");
}

// swipe support inside viewer
let _swipeX=null;
photoView.addEventListener("touchstart",(e)=>{
  _swipeX = e.touches && e.touches[0] ? e.touches[0].clientX : null;
},{passive:true});
photoView.addEventListener("touchend",(e)=>{
  if(_swipeX === null) return;
  const endX = e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : null;
  if(endX === null) return;
  const dx = endX - _swipeX;
  _swipeX = null;
  if(Math.abs(dx) < 40) return;
  if(dx < 0) nextPhoto();
  else prevPhoto();
},{passive:true});

// close photo modal outside click
photoBack.addEventListener("click",(e)=>{
  if(e.target === photoBack) closePhoto();
});

/* =========================
   ✅ PARTS (subcollection)
   inventory/{carId}/parts/{partId}
   ========================= */
function partsCol(carId){
  return ref.doc(carId).collection("parts");
}

function closeParts(){
  partsBack.style.display = "none";
  partsSub.textContent = "—";
  partsBody.innerHTML = "";
  partsCount.textContent = "0 parts";
  __partsCarId = null;
  __partsList = [];
  __editingPartId = null;
  resetPartForm();
  setNote(partsMsg, partsMsgText, "", "");
  if(__partsUnsub){ __partsUnsub(); __partsUnsub = null; }
}

function openParts(carId){
  if(!isAdmin || !carId) return;
  __partsCarId = carId;

  const car = liveCars.find(x=>x.id===carId);
  const stock = clean(car?.stockNumber) || "—";
  const veh = `${clean(car?.year)} ${clean(car?.make)} ${clean(car?.model)}`.trim();

  partsSub.textContent = `${veh || "Vehicle"} • Stock: ${stock}`;
  partsBack.style.display = "block";
  setNote(partsMsg, partsMsgText, "Loading parts…", "");
  resetPartForm();

  if(__partsUnsub){ __partsUnsub(); __partsUnsub = null; }

  __partsUnsub = partsCol(carId).orderBy("createdAt","desc").onSnapshot((s)=>{
    __partsList = [];
    s.forEach(doc=>{
      __partsList.push({ id: doc.id, ...doc.data() });
    });
    partsCount.textContent = `${__partsList.length} part${__partsList.length===1?"":"s"}`;
    setNote(partsMsg, partsMsgText, __partsList.length ? "Parts synced to this vehicle." : "No parts yet — add your first one above.", __partsList.length ? "ok" : "warn");
    renderParts();
  }, ()=>{
    setNote(partsMsg, partsMsgText, "Parts load failed. Check Firestore rules/connection.", "bad");
  });
}

function refreshParts(){
  if(!__partsCarId) return;
  showToast("Refreshing…");
  // snapshot is live; this just gives feedback
}

function renderParts(){
  partsBody.innerHTML = "";

  __partsList.forEach(p=>{
    const name = escHtml(p.partName || "Part");
    const type = escHtml(p.partType || "");
    const inter = escHtml(p.interchange || "");
    const loc = escHtml(p.location || "");
    const notes = escHtml(p.notes || "");
    const qty = (typeof p.qty === "number") ? p.qty : parseIntSafe(p.qty, 1) ?? 1;
    const price = (typeof p.price === "number") ? p.price : parseMoney(p.price);
    const core = (typeof p.core === "number") ? p.core : parseMoney(p.core);

    partsBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div style="font-weight:950">${name}</div>
          <div class="muted">
            ${type ? `${type}` : ``}
            ${type && (inter||loc) ? ` • ` : ``}
            ${inter ? `IC: ${inter}` : ``}
            ${(inter && loc) ? ` • ` : ``}
            ${loc ? `Loc: ${loc}` : ``}
          </div>
          ${notes ? `<div class="muted" style="margin-top:6px">${notes}</div>` : ``}
        </td>
        <td><span class="badgeQty">Qty <span>${qty}</span></span></td>
        <td class="money">${price!==null ? escHtml(fmtMoney(price)) : "—"}</td>
        <td class="money">${core!==null ? escHtml(fmtMoney(core)) : "—"}</td>
        <td>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="smallBtn primary" onclick="editPart('${p.id}')">Edit</button>
            <button class="smallBtn danger" onclick="deletePart('${p.id}')">Delete</button>
          </div>
        </td>
      </tr>
    `);
  });
}

function resetPartForm(){
  p_partName.value = "";
  p_partType.value = "";
  p_interchange.value = "";
  p_location.value = "";
  p_qty.value = "1";
  p_price.value = "";
  p_core.value = "";
  p_notes.value = "";
  __editingPartId = null;
  p_saveBtn.textContent = "Save Part";
}

function editPart(partId){
  const p = __partsList.find(x=>x.id===partId);
  if(!p) return;

  __editingPartId = partId;
  p_partName.value = p.partName || "";
  p_partType.value = p.partType || "";
  p_interchange.value = p.interchange || "";
  p_location.value = p.location || "";
  p_qty.value = String((typeof p.qty==="number") ? p.qty : (parseIntSafe(p.qty,1) ?? 1));
  p_price.value = (p.price ?? "") !== "" ? String(p.price ?? "") : "";
  p_core.value = (p.core ?? "") !== "" ? String(p.core ?? "") : "";
  p_notes.value = p.notes || "";
  p_saveBtn.textContent = "Update Part";
  showToast("Editing part");
}

async function savePart(){
  if(!isAdmin || !__partsCarId) return;

  const payload = {
    partName: clean(p_partName.value),
    partType: clean(p_partType.value),
    interchange: clean(p_interchange.value),
    location: clean(p_location.value),
    qty: Math.max(1, parseIntSafe(p_qty.value, 1) || 1),
    notes: clean(p_notes.value)
  };

  const price = parseMoney(p_price.value);
  const core = parseMoney(p_core.value);
  if(price !== null) payload.price = price;
  else payload.price = firebase.firestore.FieldValue.delete();
  if(core !== null) payload.core = core;
  else payload.core = firebase.firestore.FieldValue.delete();

  if(!payload.partName){
    setNote(partsMsg, partsMsgText, "Part name is required.", "warn");
    return;
  }

  try{
    p_saveBtn.disabled = true;
    setNote(partsMsg, partsMsgText, __editingPartId ? "Updating part…" : "Saving part…", "");

    if(__editingPartId){
      await partsCol(__partsCarId).doc(__editingPartId).update({
        ...payload,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setNote(partsMsg, partsMsgText, "Part updated.", "ok");
      showToast("Updated");
    }else{
      await partsCol(__partsCarId).add({
        ...payload,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setNote(partsMsg, partsMsgText, "Part added.", "ok");
      showToast("Added part");
    }

    resetPartForm();
  }catch(e){
    setNote(partsMsg, partsMsgText, "Save failed. Check rules/connection.", "bad");
  }finally{
    p_saveBtn.disabled = false;
  }
}

async function deletePart(partId){
  if(!isAdmin || !__partsCarId) return;
  if(!confirm("Delete this part?")) return;

  try{
    await partsCol(__partsCarId).doc(partId).delete();
    showToast("Part deleted");
  }catch{
    showToast("Delete failed");
  }
}

async function copyPartsCSV(){
  if(!__partsList.length){
    showToast("No parts");
    return;
  }

  const rows = [
    ["PartName","PartType","Interchange","Location","Qty","Price","Core","Notes"]
  ];

  __partsList.forEach(p=>{
    rows.push([
      String(p.partName||""),
      String(p.partType||""),
      String(p.interchange||""),
      String(p.location||""),
      String((typeof p.qty==="number")?p.qty:(parseIntSafe(p.qty,1)||1)),
      String((typeof p.price==="number")?p.price:(parseMoney(p.price)||"")),
      String((typeof p.core==="number")?p.core:(parseMoney(p.core)||"")),
      String(p.notes||"")
    ].map(x=>String(x).replace(/"/g,'""')));
  });

  const csv = rows.map(r => `"${r.join('","')}"`).join("\n");
  await copyText(csv);
  showToast("CSV copied");
}

/* close parts modal outside click */
partsBack.addEventListener("click",(e)=>{
  if(e.target === partsBack) closeParts();
});

/* =========================
   ✅ QUICK ADD PARTS by STOCK #
   ========================= */
function findCarByStock(stock){
  const s = clean(stock).toUpperCase();
  if(!s) return null;
  return liveCars.find(c => clean(c.stockNumber).toUpperCase() === s) || null;
}

function quickClear(){
  qp_stock.value = "";
  qp_vehicle.value = "";
  qp_partName.value = "";
  qp_partType.value = "";
  qp_interchange.value = "";
  qp_location.value = "";
  qp_qty.value = "";
  qp_price.value = "";
  qp_core.value = "";
  qp_notes.value = "";
  __quickCarId = null;
  setNote(qpMsg, qpMsgText, "", "");
}

function quickFindStock(){
  const stock = clean(qp_stock.value);
  if(!stock){
    setNote(qpMsg, qpMsgText, "Enter a Stock # first.", "warn");
    return;
  }

  const car = findCarByStock(stock);
  if(!car){
    __quickCarId = null;
    qp_vehicle.value = "";
    setNote(qpMsg, qpMsgText, "No vehicle found for that Stock #.", "bad");
    return;
  }

  __quickCarId = car.id;
  qp_vehicle.value = `${clean(car.year)} ${clean(car.make)} ${clean(car.model)}`.trim();
  setNote(qpMsg, qpMsgText, "Vehicle found. Add the part fields and hit Add Part.", "ok");
  showToast("Vehicle found");
}

async function quickAddPart(){
  if(!isAdmin) return;

  const stock = clean(qp_stock.value);
  const car = findCarByStock(stock);

  if(!car){
    setNote(qpMsg, qpMsgText, "Stock # not found. Hit Find Vehicle first.", "warn");
    return;
  }

  const payload = {
    partName: clean(qp_partName.value),
    partType: clean(qp_partType.value),
    interchange: clean(qp_interchange.value),
    location: clean(qp_location.value),
    qty: Math.max(1, parseIntSafe(qp_qty.value, 1) || 1),
    notes: clean(qp_notes.value),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const price = parseMoney(qp_price.value);
  const core = parseMoney(qp_core.value);
  if(price !== null) payload.price = price;
  if(core !== null) payload.core = core;

  if(!payload.partName){
    setNote(qpMsg, qpMsgText, "Part name is required.", "warn");
    return;
  }

  try{
    qp_addBtn.disabled = true;
    setNote(qpMsg, qpMsgText, "Adding part…", "");
    await partsCol(car.id).add(payload);

    // quick keep stock and vehicle, clear only part fields
    qp_partName.value = "";
    qp_partType.value = "";
    qp_interchange.value = "";
    qp_location.value = "";
    qp_qty.value = "";
    qp_price.value = "";
    qp_core.value = "";
    qp_notes.value = "";

    setNote(qpMsg, qpMsgText, `Part added to ${clean(car.stockNumber)}.`, "ok");
    showToast("Part added");
  }catch(e){
    setNote(qpMsg, qpMsgText, "Add failed. Check rules/connection.", "bad");
  }finally{
    qp_addBtn.disabled = false;
  }
}

/* ===== add/remove/edit vehicle ===== */
async function addCar(){
  const stock = clean(stockNumber.value);
  const y = clean(year.value);
  const mk = clean(make.value);
  const md = clean(model.value);
  const miles = parseMileage(mileage.value);
  const v = cleanVIN(vin.value);
  const col = clean(color.value);
  const eng = clean(engine.value);
  const trn = clean(transmission.value);
  const drv = clean(drivetrain.value);

  const gm = ynToBool(document.getElementById("goodMotor").value);
  const gt = ynToBool(document.getElementById("goodTrans").value);

  const photos = parsePhotoUrls(document.getElementById("photoUrls").value);

  if(!y || !mk || !md){
    setNote(adminMsg, adminMsgText, "Year, Make, and Model are required. (Tip: paste VIN to auto-fill.)", "warn");
    return;
  }
  if(v && !validVIN(v)){
    setNote(adminMsg, adminMsgText, "VIN must be 17 chars (no I/O/Q).", "warn");
    return;
  }

  addBtn.disabled = true;
  setNote(adminMsg, adminMsgText, "Saving…", "");

  try{
    // ✅ ensure stock #
    let finalStock = stock;
    if(!finalStock){
      finalStock = await nextStockNumber();
      stockNumber.value = finalStock;
    }

    const payload = {
      stockNumber: finalStock,
      year:y,
      make:mk,
      model:md,
      vin:v,
      color:col,
      engine:eng,
      transmission:trn,
      drivetrain:drv,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if(miles !== null) payload.mileage = miles;
    if(photos.length) payload.photos = photos;

    if(gm !== null) payload.goodMotor = gm;
    if(gt !== null) payload.goodTrans = gt;

    await ref.add(payload);

    document.querySelectorAll('#adminPanel input').forEach(i=>i.value="");
    document.getElementById("goodMotor").value = "";
    document.getElementById("goodTrans").value = "";
    document.getElementById("photoUrls").value = "";

    setNote(adminMsg, adminMsgText, `Vehicle added. Stock #: ${finalStock}`, "ok");
    showToast("Added");

  }catch(e){
    setNote(adminMsg, adminMsgText, "Save failed. Check connection/rules.", "bad");
  }

  addBtn.disabled = false;
}

async function removeCar(id){
  if(!isAdmin) return;
  if(!confirm("Delete this vehicle? (parts will remain only if rules allow orphaned data)")) return;

  try{
    await ref.doc(id).delete();
    showToast("Deleted");
  }catch{
    showToast("Delete failed");
  }
}

function scrollToAdmin(){
  adminPanel.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ===== EDIT FLOW ===== */
function openEdit(id){
  if(!isAdmin) return;
  const car = liveCars.find(x=>x.id===id);
  if(!car) return;

  editingId = id;

  e_stockNumber.value = car.stockNumber || "";
  e_year.value = car.year || "";
  e_make.value = car.make || "";
  e_model.value = car.model || "";
  e_mileage.value = (car.mileage ?? "") !== "" ? String(car.mileage ?? "") : "";
  e_vin.value = car.vin || "";
  e_color.value = car.color || "";
  e_engine.value = car.engine || "";
  e_transmission.value = car.transmission || "";
  e_drivetrain.value = car.drivetrain || "";
  e_goodMotor.value = boolToYN(car.goodMotor);
  e_goodTrans.value = boolToYN(car.goodTrans);
  e_photoUrls.value = Array.isArray(car.photos) ? car.photos.join(", ") : "";

  setNote(editMsg, editMsgText, "", "");
  editBack.style.display = "block";
}

function closeEdit(){
  editBack.style.display = "none";
  editingId = null;
  setNote(editMsg, editMsgText, "", "");
}

async function saveEdit(){
  if(!isAdmin || !editingId) return;

  const stock = clean(e_stockNumber.value);
  const y = clean(e_year.value);
  const mk = clean(e_make.value);
  const md = clean(e_model.value);
  const miles = parseMileage(e_mileage.value);
  const v = cleanVIN(e_vin.value);
  const col = clean(e_color.value);
  const eng = clean(e_engine.value);
  const trn = clean(e_transmission.value);
  const drv = clean(e_drivetrain.value);

  const gm = ynToBool(e_goodMotor.value);
  const gt = ynToBool(e_goodTrans.value);

  const photos = parsePhotoUrls(e_photoUrls.value);

  if(!y || !mk || !md){
    setNote(editMsg, editMsgText, "Year, Make, and Model are required.", "warn");
    return;
  }
  if(v && !validVIN(v)){
    setNote(editMsg, editMsgText, "VIN must be 17 chars (no I/O/Q).", "warn");
    return;
  }

  saveBtn.disabled = true;
  setNote(editMsg, editMsgText, "Saving…", "");

  try{
    // ✅ ensure stock #
    let finalStock = stock;
    if(!finalStock){
      finalStock = await nextStockNumber();
      e_stockNumber.value = finalStock;
    }

    const updates = {
      stockNumber: finalStock,
      year:y,
      make:mk,
      model:md,
      vin:v,
      color:col,
      engine:eng,
      transmission:trn,
      drivetrain:drv
    };

    if(miles === null){
      updates.mileage = firebase.firestore.FieldValue.delete();
    }else{
      updates.mileage = miles;
    }

    if(!photos.length){
      updates.photos = firebase.firestore.FieldValue.delete();
    }else{
      updates.photos = photos;
    }

    updates.goodMotor = (gm === null) ? firebase.firestore.FieldValue.delete() : gm;
    updates.goodTrans = (gt === null) ? firebase.firestore.FieldValue.delete() : gt;

    await ref.doc(editingId).update(updates);

    setNote(editMsg, editMsgText, "Saved.", "ok");
    showToast("Saved");
    setTimeout(closeEdit, 550);

  }catch(e){
    setNote(editMsg, editMsgText, "Save failed. Check connection/rules.", "bad");
  }

  saveBtn.disabled = false;
}

async function deleteFromEdit(){
  if(!isAdmin || !editingId) return;
  if(!confirm("Delete this vehicle?")) return;

  try{
    await ref.doc(editingId).delete();
    showToast("Deleted");
    closeEdit();
  }catch{
    showToast("Delete failed");
  }
}

/* Close modal on outside click */
editBack.addEventListener("click",(e)=>{
  if(e.target === editBack) closeEdit();
});
document.addEventListener("keydown",(e)=>{
  if(e.key === "Escape"){
    closeEdit();
    closePhoto();
    closeParts();
  }
});

/* ===== live render with snapshot ===== */
function startListener(){
  if(unsub) unsub();

  setNote(invMsg, invMsgText, "Loading inventory…", "");
  countLine.textContent = "Loading…";
  liveHint.textContent = "Connecting…";

  unsub = ref.orderBy("createdAt","desc").onSnapshot(s=>{
    liveCars = [];
    s.forEach(doc=>{
      liveCars.push({ id: doc.id, ...doc.data() });
    });

    countLine.textContent = `${liveCars.length} vehicles`;
    liveHint.textContent = "Live sync on";
    setNote(invMsg, invMsgText, liveCars.length ? "Tap Stock/VIN to copy. Admin: open Parts per vehicle." : "No vehicles yet.", liveCars.length ? "" : "warn");
    applyFilters();
  }, ()=>{
    setNote(invMsg, invMsgText, "Live sync failed. Check Firestore rules/connection.", "bad");
    countLine.textContent = "Error";
    liveHint.textContent = "Offline";
  });
}

/* ===== filters/sort ===== */
function applyFilters(){
  const q = clean(searchEl.value).toLowerCase();
  const sort = sortEl.value;

  let list = liveCars.slice();

  list.forEach(c=>{
    c._ts = getMs(c.createdAt);
    c._miles = (typeof c.mileage === "number") ? c.mileage : (parseMileage(String(c.mileage||"")) ?? null);
  });

  if(q){
    list = list.filter(c=>{
      const blob = [
        c.stockNumber, // ✅ searchable
        c.year, c.make, c.model, c.vin, c.color, c.engine, c.transmission, c.drivetrain,
        c.mileage,
        (c.goodMotor===true ? "good motor" : c.goodMotor===false ? "bad motor" : ""),
        (c.goodTrans===true ? "good transmission" : c.goodTrans===false ? "bad transmission" : "")
      ].map(x=>String(x||"").toLowerCase()).join(" ");
      return blob.includes(q);
    });
  }

  list.sort((a,b)=>{
    const ay = parseInt(a.year||"0",10) || 0;
    const by = parseInt(b.year||"0",10) || 0;
    const am = a._miles ?? 9e15;
    const bm = b._miles ?? 9e15;

    if(sort==="newest") return (b._ts||0) - (a._ts||0);
    if(sort==="oldest") return (a._ts||0) - (b._ts||0);
    if(sort==="yearDesc") return by - ay;
    if(sort==="yearAsc") return ay - by;
    if(sort==="makeAsc") return String(a.make||"").localeCompare(String(b.make||""));
    if(sort==="milesAsc") return am - bm;
    if(sort==="milesDesc") return bm - am;
    return 0;
  });

  renderTable(list);
  document.querySelectorAll(".photoTrack").forEach(enableDragScroll);
}

/* derive a sortable timestamp from Firestore Timestamp if present */
function getMs(t){
  try{
    if(!t) return 0;
    if(typeof t.toMillis === "function") return t.toMillis();
    return 0;
  }catch{return 0;}
}

function ynLabel(b, what){
  if(b===true) return `${what}: Good ✅`;
  if(b===false) return `${what}: Bad ❌`;
  return "";
}

function buildPhotoSquare(carId, photos){
  const arr = Array.isArray(photos) ? photos.filter(Boolean) : [];
  __photosByCarId[carId] = arr;

  if(!arr.length){
    return `
      <div class="photoSquare">
        <div class="photoFallback">NO PHOTOS</div>
      </div>
    `;
  }

  const imgs = arr.map((u,i)=>{
    const safe = escHtml(u);
    return `<img src="${safe}" alt="Vehicle photo" loading="lazy" onclick="openPhoto('${carId}', ${i})" onerror="this.style.display='none'">`;
  }).join("");

  return `
    <div class="photoSquare hasPhotos">
      <div class="photoBadge"><span>${arr.length}</span> photo${arr.length===1?"":"s"}</div>
      <div class="photoTrack" aria-label="Vehicle photos">
        ${imgs}
      </div>
    </div>
  `;
}

function renderTable(list){
  inventoryBody.innerHTML = "";

  list.forEach(c=>{
    const vehicleLine = `${escHtml(c.year||"")} ${escHtml(c.make||"")} ${escHtml(c.model||"")}`.trim() || "Vehicle";
    const vinVal = escHtml(c.vin||"");
    const stockVal = escHtml(c.stockNumber||"");

    const specsArr = [c.color, c.engine, c.transmission, c.drivetrain].filter(Boolean).map(escHtml);

    const gmText = ynLabel(c.goodMotor, "Motor");
    const gtText = ynLabel(c.goodTrans, "Trans");
    if(gmText) specsArr.push(escHtml(gmText));
    if(gtText) specsArr.push(escHtml(gtText));

    const specs = specsArr.join(" · ");

    const tags = [];
    const milesLabel = fmtMiles(c.mileage);
    if(stockVal) tags.push(`<span class="tag stock">Stock: ${stockVal}</span>`);
    if(milesLabel) tags.push(`<span class="tag miles">${escHtml(milesLabel)}</span>`);
    if(c.drivetrain) tags.push(`<span class="tag">${escHtml(c.drivetrain)}</span>`);
    if(c.transmission) tags.push(`<span class="tag">${escHtml(c.transmission)}</span>`);
    if(c.engine) tags.push(`<span class="tag">${escHtml(c.engine)}</span>`);
    if(c.goodMotor===true) tags.push(`<span class="tag ok">Good Motor ✅</span>`);
    if(c.goodMotor===false) tags.push(`<span class="tag bad">Bad Motor ❌</span>`);
    if(c.goodTrans===true) tags.push(`<span class="tag ok">Good Trans ✅</span>`);
    if(c.goodTrans===false) tags.push(`<span class="tag bad">Bad Trans ❌</span>`);

    const photoSquare = buildPhotoSquare(c.id, c.photos);

    inventoryBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div class="gallery">
            ${photoSquare}
            <div style="min-width:0">
              <strong>${vehicleLine}</strong>
              ${specs ? `<div class="specs">${specs}</div>` : ``}
              ${tags.length ? `<div class="kv">${tags.join("")}</div>` : ``}
            </div>
          </div>
        </td>

        <td>
          <div class="copyLine">
            ${stockVal ? `<button class="smallBtn" onclick="copyText('${stockVal}')">Copy Stock</button>` : ``}
            ${vinVal ? `<button class="smallBtn ghost" onclick="copyText('${vinVal}')">Copy VIN</button>` : ``}
          </div>

          <div class="specs" style="margin-top:8px">
            ${stockVal ? `<div><strong>Stock:</strong> ${stockVal}</div>` : `<div>Stock: —</div>`}
            ${vinVal ? `<div><strong>VIN:</strong> ${vinVal}</div>` : `<div>VIN: —</div>`}
          </div>
        </td>

        <td class="admin-only admin-cell">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="smallBtn primary" onclick="openEdit('${c.id}')">Edit</button>
            <button class="smallBtn" onclick="openParts('${c.id}')">Parts</button>
            <button class="smallBtn danger" onclick="removeCar('${c.id}')">Delete</button>
          </div>
        </td>
      </tr>
    `);
  });
}

async function copyText(t){
  try{
    await navigator.clipboard.writeText(t);
    showToast("Copied");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied");
  }
}

function clearSearch(){
  searchEl.value = "";
  applyFilters();
}

/* ===== restore admin session ===== */
(function init(){
  const saved = localStorage.getItem("tlb_admin") === "1";
  setAdminUI(saved);

  hookVinAutoFill();
  startListener();

  // ✅ nice default qty
  if(document.getElementById("p_qty")) p_qty.value="1";

  setNote(invMsg, invMsgText, "Loading inventory…", "");
  setNote(loginMsg, loginMsgText, "", "");
  setNote(adminMsg, adminMsgText, "", "");
})();
</script>

</body>
</html>
