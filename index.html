<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Two Little Bees – Inventory</title>

<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#0b0f14">
<meta name="description" content="Two Little Bees Auto Parts inventory — VIN-verified OEM used parts in Indianapolis.">

<!-- Firebase (COMPAT SDK for single-file HTML) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#101826;
  --panel-soft:#0f172a;
  --card:#0d1626;
  --accent:#f4c430;
  --accent2:#ffb703;
  --text:#f9fafb;
  --muted:#9ca3af;
  --danger:#ff4d4d;
  --ok:#22c55e;
  --warn:#f59e0b;
  --border:rgba(255,255,255,.10);
  --shadow:0 30px 70px rgba(0,0,0,.60);
  --radius:18px;
  --radius2:14px;
  --glass:rgba(11,15,20,.72);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
html,body{width:100%;max-width:100%;overflow-x:hidden}
a{color:inherit;text-decoration:none}
::selection{background:rgba(244,196,48,.22)}

body{
  background:
    radial-gradient(1000px 600px at 15% -10%, rgba(244,196,48,.16), transparent 60%),
    radial-gradient(1000px 600px at 90% 0%, rgba(255,183,3,.12), transparent 60%),
    radial-gradient(900px 500px at 40% 115%, rgba(31,41,55,.28), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 22%),
    var(--bg);
  color:var(--text);
  padding-left:env(safe-area-inset-left);
  padding-right:env(safe-area-inset-right);
  padding-bottom:calc(env(safe-area-inset-bottom) + 18px);
  -webkit-font-smoothing:antialiased;
}

@media (prefers-reduced-motion:no-preference){
  .lift{transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
  .lift:hover{transform:translateY(-2px); box-shadow:0 40px 85px rgba(0,0,0,.62); border-color:rgba(244,196,48,.30)}
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(11,15,20,.88);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,.08);
}

.header-inner{
  max-width:1200px;
  margin:auto;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  flex-wrap:wrap;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:240px;
}

.logo{
  width:64px;
  height:64px;
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  border-radius:0;
  object-fit:contain;
  display:block;
  cursor:pointer;
  image-rendering:auto;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,.45));
}

@media(max-width:700px){
  .logo{ width:58px; height:58px; }
}

.titleWrap h2{
  font-size:1.05rem;
  letter-spacing:.2px;
  font-weight:950;
}
.titleWrap .sub{
  color:var(--muted);
  font-size:.85rem;
  margin-top:2px;
}

.header-actions{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.pill{
  text-decoration:none;
  font-weight:950;
  padding:9px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  background:rgba(15,23,42,.55);
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

.pill.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;
  border:none;
}
.pill:active{transform:scale(.99)}

/* MAIN */
main{
  max-width:1200px;
  margin:auto;
  padding:22px 16px 42px;
}

/* CARD */
.card{
  background:
    radial-gradient(700px 280px at 0% 0%, rgba(244,196,48,.09), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
    var(--panel);
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow);
  margin-bottom:18px;
}

.cardHead{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

.card h3{font-size:1.05rem; font-weight:950}
.mini{
  color:var(--muted);
  font-size:.85rem;
  font-weight:800;
}

hr.sep{
  border:none;
  height:1px;
  background:rgba(255,255,255,.10);
  margin:14px 0;
}

/* FORMS */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
}

input,button,select,textarea{
  background:#0f1422;
  color:#fff;
  border:1px solid rgba(255,255,255,.15);
  padding:12px;
  border-radius:var(--radius2);
  outline:none;
}

textarea{min-height:44px; resize:vertical}
input::placeholder, textarea::placeholder{color:rgba(156,163,175,.85)}

input:focus,select:focus,textarea:focus{
  border-color:rgba(244,196,48,.65);
  box-shadow:0 0 0 4px rgba(244,196,48,.14);
}

button{cursor:pointer;font-weight:950}
button[disabled]{opacity:.6;cursor:not-allowed}

button.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;
  border:none;
}

button.danger{
  background:var(--danger);
  border:none;
  color:#000;
}

button.ghost{
  background:rgba(255,255,255,.06);
}

.note{
  margin-top:10px;
  font-size:12px;
  min-height:18px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
}
.note .dot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,.18);
  box-shadow:0 0 0 3px rgba(255,255,255,.06);
}
.note.ok{color:var(--ok)}
.note.ok .dot{background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.18)}
.note.bad{color:var(--danger)}
.note.bad .dot{background:var(--danger);box-shadow:0 0 0 3px rgba(255,77,77,.18)}
.note.warn{color:var(--warn)}
.note.warn .dot{background:var(--warn);box-shadow:0 0 0 3px rgba(245,158,11,.18)}

/* FILTER BAR */
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}
.toolbar input{ flex:1 1 260px; }

.smallHint{
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
}
.pulseDot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(244,196,48,.85);
  box-shadow:0 0 0 6px rgba(244,196,48,.12);
}

/* TABLE */
.table-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  max-height:560px;
  overflow-y:auto;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(15,23,42,.16);

  -ms-overflow-style:none;
  scrollbar-width:none;
}
.table-wrap::-webkit-scrollbar{width:0;height:0;display:none}

table{
  width:100%;
  min-width:980px;
  border-collapse:collapse;
  margin-top:12px;
}

table thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:rgba(11,15,20,.96);
  backdrop-filter:blur(10px);
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  vertical-align:top;
}

th{
  color:var(--accent);
  font-weight:950;
  font-size:.9rem;
}

td strong{font-weight:950}

.specs{
  font-size:13px;
  color:var(--muted);
  margin-top:4px;
  line-height:1.35;
}

.kv{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}
.tag{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  background:rgba(15,23,42,.55);
  font-weight:900;
}

.tag.ok{
  border-color: rgba(34,197,94,.35);
  background: rgba(34,197,94,.10);
}
.tag.bad{
  border-color: rgba(255,77,77,.35);
  background: rgba(255,77,77,.10);
}
.tag.miles{
  border-color: rgba(244,196,48,.35);
  background: rgba(244,196,48,.10);
  color:#fff;
}
.tag.stock{
  border-color: rgba(244,196,48,.35);
  background: rgba(244,196,48,.08);
}

/* Small action buttons in table */
.smallBtn{
  padding:9px 10px;
  border-radius:12px;
  font-weight:950;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
}
.smallBtn:active{transform:scale(.99)}
.smallBtn.danger{background:var(--danger);border:none;color:#000}
.smallBtn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;border:none}

/* ADMIN VISIBILITY */
.admin-only{ display:none; }
body.is-admin .admin-flex{ display:inline-flex; }
body.is-admin .admin-block{ display:block; }
body.is-admin th.admin-cell,
body.is-admin td.admin-cell{ display:table-cell; }

/* TOAST */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(env(safe-area-inset-bottom) + 14px);
  background:rgba(15,23,42,.92);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  border-radius:12px;
  font-size:12px;
  color:var(--text);
  display:none;
  z-index:9999;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}

/* MODAL */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  z-index:9998;
  padding:18px;
}
.modal{
  max-width:920px;
  margin:6vh auto 0;
  background:
    radial-gradient(700px 300px at 0% 0%, rgba(244,196,48,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
    var(--panel);
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.modalHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
.modalHead h3{ font-size:1.05rem; font-weight:950 }
.modalActions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}
.xBtn{
  width:42px;height:42px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:950;
  cursor:pointer;
}

/* PHOTO SQUARE */
.gallery{ display:flex; align-items:flex-start; gap:12px; }

.photoSquare{
  width:112px;
  height:112px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120px 120px at 30% 20%, rgba(244,196,48,.14), transparent 60%),
    rgba(255,255,255,.04);
  overflow:hidden;
  position:relative;
  flex:0 0 auto;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
}

.photoTrack{
  width:100%;
  height:100%;
  display:flex;
  overflow-x:auto;
  overflow-y:hidden;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  touch-action:pan-x;
  cursor:grab;
}
.photoTrack:active{ cursor:grabbing; }
.photoTrack::-webkit-scrollbar{display:none}
.photoTrack img{
  width:112px;
  height:112px;
  object-fit:cover;
  flex:0 0 auto;
  scroll-snap-align:start;
  user-select:none;
  -webkit-user-drag:none;
  pointer-events:auto;
  cursor:pointer;
}

.photoFallback{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:rgba(156,163,175,.95);
  font-weight:950;
  font-size:12px;
  letter-spacing:.2px;
}

.photoBadge{
  position:absolute;
  top:8px;
  left:8px;
  padding:6px 8px;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.14);
  font-size:11px;
  font-weight:950;
  color:#fff;
  backdrop-filter:blur(8px);
  display:none;
  pointer-events:none;
}
.photoSquare.hasPhotos .photoBadge{display:inline-block}
.photoBadge span{color:rgba(244,196,48,.95)}

.copyLine{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* PHOTO VIEWER */
.photoViewer{ display:flex; flex-direction:column; gap:12px; }
.photoViewerTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.photoViewerImgWrap{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  background:rgba(255,255,255,.04);
  max-height:70vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
#photoView{ max-width:100%; max-height:70vh; object-fit:contain; display:block; }
.photoViewerNav{ display:flex; gap:10px; flex-wrap:wrap; }

/* PARTS */
.partsWrap{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  overflow:hidden;
  background:rgba(15,23,42,.18);
}
.partsHeader{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.partsHeader .mini{margin:0}
.partsTable{
  width:100%;
  border-collapse:collapse;
}
.partsTable th, .partsTable td{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.partsTable th{
  color:var(--accent);
  font-size:.85rem;
  text-align:left;
}
.partsTable td{ font-size:.92rem; }
.partsTools{ display:flex; gap:8px; flex-wrap:wrap; }
.badgeQty{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-weight:950;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.badgeQty span{ color: rgba(244,196,48,.95); }
.money{ font-weight:950; }
.muted{ color:var(--muted); font-size:12px; }

/* MOBILE */
@media(max-width:700px){
  html,body{ overflow-x:hidden; }

  .table-wrap{ overflow-x:hidden; max-height:none; border:0; background:transparent; padding:0; }

  table{ min-width:0 !important; width:100%; margin-top:12px; }
  thead{ display:none; }
  tbody, tr, td{ display:block; width:100%; }

  tr{
    background:rgba(15,23,42,.35);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    margin:12px 0;
  }

  td{ border:none; padding:0; }
  td + td{ margin-top:12px; }
  body.is-admin td.admin-cell{ display:block; }

  .photoSquare{ width:104px; height:104px; }
  .photoTrack img{ width:104px; height:104px; }

  .partsHeader{ gap:12px; }
  .partsTable thead{ display:none; }
  .partsTable, .partsTable tbody, .partsTable tr, .partsTable td{ display:block; width:100%; }
  .partsTable tr{ border-bottom:1px solid rgba(255,255,255,.10); padding:10px 12px; }
  .partsTable td{ border:none; padding:6px 0; }
}
</style>
</head>

<body>

<div class="toast" id="toast">Copied</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <img
        src="https://github.com/twolittlebeesautoparts/twolittlebeesautoparts.github.io/blob/main/new.logo@2x.png%20(2000%E2%80%933000px%20wide).png?raw=true"
        class="logo"
        alt="Two Little Bees Auto Parts Logo"
        onclick="beeSecret()"
      />
      <div class="titleWrap">
        <h2>Inventory</h2>
        <div class="sub">Live list • VIN-verified • Indianapolis</div>
      </div>
    </div>

    <div class="header-actions">
      <a class="pill" href="https://twolittlebeesautoparts.github.io/OFFICIALPAGE/">Home</a>
      <a class="pill primary" href="https://twolittlebeesautoparts.github.io/">Search Inventory</a>
      <a class="pill admin-only admin-flex" href="javascript:void(0)" onclick="logout()">Logout</a>
    </div>
  </div>
</header>

<main>

  <!-- LOGIN (hidden until secret tap) -->
  <div class="card lift" id="loginCard" style="display:none">
    <div class="cardHead">
      <div>
        <h3>Admin Login</h3>
        <div class="mini">Tap logo 3 times to open this screen</div>
      </div>
    </div>
    <hr class="sep">
    <div class="grid">
      <input id="username" placeholder="Admin Email (Firebase Auth)" autocomplete="username">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
      <button class="primary" onclick="login()">Login</button>
    </div>
    <div id="loginMsg" class="note"><span class="dot"></span><span id="loginMsgText"></span></div>
  </div>

  <!-- INVENTORY -->
  <div class="card lift">
    <div class="cardHead">
      <div>
        <h3>Current Inventory</h3>
        <div class="mini" id="countLine">Loading…</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="smallHint"><span class="pulseDot"></span><span id="liveHint">Live sync on</span></div>
        <button class="smallBtn admin-only admin-flex" onclick="scrollToAdmin()">+ Add Vehicle</button>
      </div>
    </div>

    <div class="toolbar">
      <input id="search" placeholder="Search stock #, year, make, model, VIN, engine, mileage…" oninput="applyFilters()">
      <select id="sort" onchange="applyFilters()">
        <option value="newest">Sort: Newest</option>
        <option value="oldest">Sort: Oldest</option>
        <option value="yearDesc">Sort: Year (High → Low)</option>
        <option value="yearAsc">Sort: Year (Low → High)</option>
        <option value="makeAsc">Sort: Make (A → Z)</option>
        <option value="milesAsc">Sort: Mileage (Low → High)</option>
        <option value="milesDesc">Sort: Mileage (High → Low)</option>
      </select>
      <button class="smallBtn ghost" onclick="clearSearch()">Clear</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:56%">Vehicle</th>
            <th style="width:24%">VIN / Stock</th>
            <th style="width:20%" class="admin-only admin-cell">Actions</th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>
    </div>

    <div id="invMsg" class="note"><span class="dot"></span><span id="invMsgText"></span></div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card admin-only admin-block lift" id="adminPanel">
    <div class="cardHead">
      <div>
        <h3>Add Vehicle</h3>
        <div class="mini">Tip: paste VIN and it will auto-fill Year/Make/Model + more.</div>
      </div>
    </div>
    <hr class="sep">

    <div class="grid">
      <input id="stockNumber" placeholder="Stock # (auto)" disabled>
      <button class="ghost" type="button" onclick="generateStockToForm(false)">Generate Stock #</button>

      <input id="year" placeholder="Year (e.g. 2017)" inputmode="numeric">
      <input id="make" placeholder="Make (Brand)">
      <input id="model" placeholder="Model">
      <input id="mileage" placeholder="Mileage (e.g. 128000)" inputmode="numeric">

      <input id="vin" placeholder="VIN (17 chars)" maxlength="17">
      <button class="ghost" type="button" onclick="autoFillFromVIN(false)">Auto-Fill from VIN</button>

      <input id="color" placeholder="Color">
      <input id="engine" placeholder="Engine Size (e.g. 3.6L)">
      <input id="transmission" placeholder="Transmission (Auto / Manual / CVT)">
      <input id="drivetrain" placeholder="Drivetrain (FWD / RWD / AWD)">

      <select id="goodMotor">
        <option value="">Good Motor? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>
      <select id="goodTrans">
        <option value="">Good Transmission? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>

      <textarea id="photoUrls" placeholder="Photo URLs (comma-separated)&#10;Example: https://...1.jpg, https://...2.jpg"></textarea>

      <button class="primary" id="addBtn" onclick="addCar()">Add Vehicle</button>
    </div>

    <div id="adminMsg" class="note"><span class="dot"></span><span id="adminMsgText"></span></div>
  </div>

</main>

<footer style="border-top:1px solid rgba(255,255,255,.08);text-align:center;padding:22px 16px;color:var(--muted)">
  © 2026 Two Little Bees Auto Parts
</footer>

<!-- EDIT MODAL (admin) -->
<div class="modalBack admin-only" id="editBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>Edit Vehicle</h3>
        <div class="mini" id="editSub">Update details then hit Save.</div>
      </div>
      <button class="xBtn" onclick="closeEdit()">✕</button>
    </div>

    <hr class="sep">

    <div class="grid">
      <input id="e_stockNumber" placeholder="Stock # (auto)" disabled>
      <button class="ghost" type="button" onclick="generateStockToForm(true)">Generate Stock #</button>

      <input id="e_year" placeholder="Year (e.g. 2017)" inputmode="numeric">
      <input id="e_make" placeholder="Make (Brand)">
      <input id="e_model" placeholder="Model">
      <input id="e_mileage" placeholder="Mileage (e.g. 128000)" inputmode="numeric">

      <input id="e_vin" placeholder="VIN (17 chars)" maxlength="17">
      <button class="ghost" type="button" onclick="autoFillFromVIN(true)">Auto-Fill from VIN</button>

      <input id="e_color" placeholder="Color">
      <input id="e_engine" placeholder="Engine Size (e.g. 3.6L)">
      <input id="e_transmission" placeholder="Transmission (Auto / Manual / CVT)">
      <input id="e_drivetrain" placeholder="Drivetrain (FWD / RWD / AWD)">

      <select id="e_goodMotor">
        <option value="">Good Motor? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>
      <select id="e_goodTrans">
        <option value="">Good Transmission? (optional)</option>
        <option value="yes">Yes ✅</option>
        <option value="no">No ❌</option>
      </select>

      <textarea id="e_photoUrls" placeholder="Photo URLs (comma-separated)"></textarea>
    </div>

    <div class="modalActions">
      <button class="primary" id="saveBtn" onclick="saveEdit()">Save Changes</button>
      <button class="ghost" onclick="closeEdit()">Cancel</button>
      <button class="smallBtn" onclick="openParts(editingId)">Parts</button>
      <button class="danger" onclick="deleteFromEdit()">Delete</button>
    </div>

    <div id="editMsg" class="note"><span class="dot"></span><span id="editMsgText"></span></div>
  </div>
</div>

<!-- PARTS MODAL (PUBLIC VIEW + ADMIN EDIT) -->
<div class="modalBack" id="partsBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>Vehicle Parts</h3>
        <div class="mini" id="partsSub">—</div>
      </div>
      <button class="xBtn" onclick="closeParts()">✕</button>
    </div>

    <hr class="sep">

    <!-- Admin-only add/edit form -->
    <div class="admin-only admin-block">
      <div class="grid">
        <input id="p_partName" placeholder="Part Name (ex: Alternator)">
        <input id="p_partType" placeholder="Part Type (ex: Engine / Body / Module)">
        <input id="p_interchange" placeholder="Interchange # (optional)">
        <input id="p_location" placeholder="Location (ex: Rack A-3)">
        <input id="p_qty" placeholder="Qty (ex: 1)" inputmode="numeric" value="1">
        <input id="p_price" placeholder="Price (ex: 150)" inputmode="decimal">
        <input id="p_core" placeholder="Core (optional)" inputmode="decimal">
        <textarea id="p_notes" placeholder="Notes (optional)"></textarea>

        <button class="primary" id="p_saveBtn" onclick="savePart()">Save Part</button>
        <button class="ghost" onclick="resetPartForm()">New Part</button>
      </div>

      <div class="note" id="partsMsg"><span class="dot"></span><span id="partsMsgText"></span></div>
      <div style="height:12px"></div>
    </div>

    <!-- Public note -->
    <div class="note" id="partsPublicNote"><span class="dot"></span><span id="partsPublicNoteText"></span></div>

    <div class="partsWrap" style="margin-top:12px">
      <div class="partsHeader">
        <div>
          <div class="mini" id="partsCount">0 parts</div>
          <div class="muted">Public can view. Admin can edit.</div>
        </div>
        <div class="partsTools">
          <button class="smallBtn ghost" onclick="refreshParts()">Refresh</button>
          <button class="smallBtn" onclick="copyPartsCSV()">Copy CSV</button>
        </div>
      </div>

      <div style="max-height:420px; overflow:auto; -webkit-overflow-scrolling:touch">
        <table class="partsTable">
          <thead>
            <tr>
              <th style="width:34%">Part</th>
              <th style="width:14%">Qty</th>
              <th style="width:14%">Price</th>
              <th style="width:14%">Core</th>
              <th style="width:24%">Actions</th>
            </tr>
          </thead>
          <tbody id="partsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- PHOTO VIEWER (anyone can use) -->
<div class="modalBack" id="photoBack">
  <div class="modal">
    <div class="photoViewer">
      <div class="photoViewerTop">
        <div>
          <h3 style="font-size:1.05rem;font-weight:950">Photo Viewer</h3>
          <div class="mini" id="photoSub">—</div>
        </div>
        <button class="xBtn" onclick="closePhoto()">✕</button>
      </div>

      <div class="photoViewerImgWrap">
        <img id="photoView" alt="Vehicle photo">
      </div>

      <div class="photoViewerNav">
        <button class="smallBtn ghost" onclick="prevPhoto()">◀ Prev</button>
        <button class="smallBtn ghost" onclick="nextPhoto()">Next ▶</button>
        <button class="smallBtn" onclick="openPhotoInNewTab()">Open in new tab</button>
        <button class="smallBtn ghost" onclick="copyCurrentPhotoUrl()">Copy URL</button>
      </div>

      <div class="note" id="photoMsg"><span class="dot"></span><span id="photoMsgText"></span></div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   FIRESTORE RULES YOU MUST SET (PUBLIC VIEW + ADMIN WRITE)
   =========================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /inventory/{carId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;

      match /parts/{partId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null;
      }
    }
    match /meta/stockCounter {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
*/

/* ========================
   FIREBASE INIT (COMPAT)
======================== */
firebase.initializeApp({
  apiKey: "AIzaSyBVumo8QP3m18p33ugqx_eNADsjHG0gJS0",
  authDomain: "two-little-bees-inventory.firebaseapp.com",
  projectId: "two-little-bees-inventory",
  storageBucket: "two-little-bees-inventory.firebasestorage.app",
  messagingSenderId: "669354511397",
  appId: "1:669354511397:web:a5e4565496e097f85483cc",
  measurementId: "G-736B95M78E"
});

const auth = firebase.auth();
const db = firebase.firestore();
const ref = db.collection("inventory");
const metaRef = db.collection("meta").doc("stockCounter");

/* UI refs */
const loginCard = document.getElementById("loginCard");
const inventoryBody = document.getElementById("inventoryBody");
const toast = document.getElementById("toast");

const loginMsg = document.getElementById("loginMsg");
const loginMsgText = document.getElementById("loginMsgText");
const invMsg = document.getElementById("invMsg");
const invMsgText = document.getElementById("invMsgText");
const adminMsg = document.getElementById("adminMsg");
const adminMsgText = document.getElementById("adminMsgText");
const editMsg = document.getElementById("editMsg");
const editMsgText = document.getElementById("editMsgText");

const countLine = document.getElementById("countLine");
const liveHint = document.getElementById("liveHint");

const searchEl = document.getElementById("search");
const sortEl = document.getElementById("sort");

let isAdmin = false;
let beeClicks = 0;
let liveCars = [];
let unsub = null;

/* EDIT */
const editBack = document.getElementById("editBack");
let editingId = null;

/* PHOTO VIEWER */
const photoBack = document.getElementById("photoBack");
const photoView = document.getElementById("photoView");
const photoSub = document.getElementById("photoSub");
const photoMsg = document.getElementById("photoMsg");
const photoMsgText = document.getElementById("photoMsgText");
let __photosByCarId = {};
let __currentPhoto = { carId:null, idx:0 };

/* PARTS */
const partsBack = document.getElementById("partsBack");
const partsSub = document.getElementById("partsSub");
const partsBody = document.getElementById("partsBody");
const partsCount = document.getElementById("partsCount");
const partsPublicNote = document.getElementById("partsPublicNote");
const partsPublicNoteText = document.getElementById("partsPublicNoteText");
const partsMsg = document.getElementById("partsMsg");
const partsMsgText = document.getElementById("partsMsgText");

let __partsCarId = null;
let __partsUnsub = null;
let __partsList = [];
let __editingPartId = null;

/* ===== helpers ===== */
function setNote(el, textEl, msg, type=""){
  textEl.textContent = msg || "";
  el.className = "note" + (type ? " " + type : "");
}
function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.style.display="none", 950);
}
function escHtml(str){
  return String(str ?? "").replace(/[&<>"']/g,(m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function clean(str){ return String(str ?? "").trim(); }
function cleanVIN(v){ return clean(v).toUpperCase().replace(/[^A-Z0-9]/g,""); }
function validVIN(v){ return v.length === 17 && !/[IOQ]/.test(v); }

function ynToBool(v){ if(v==="yes") return true; if(v==="no") return false; return null; }
function boolToYN(b){ if(b===true) return "yes"; if(b===false) return "no"; return ""; }

function parseMileage(v){
  const raw = clean(v).replace(/[^\d]/g,"");
  if(!raw) return null;
  const n = parseInt(raw, 10);
  return Number.isFinite(n) ? n : null;
}
function fmtMiles(n){
  if(n===null || n===undefined || n==="") return "";
  const num = typeof n === "number" ? n : parseMileage(String(n));
  if(num===null) return "";
  return num.toLocaleString() + " mi";
}
function parseMoney(v){
  const t = clean(v).replace(/[^0-9.]/g,"");
  if(!t) return null;
  const n = Number(t);
  return Number.isFinite(n) ? Math.round(n*100)/100 : null;
}
function fmtMoney(n){
  if(n===null || n===undefined) return "";
  const num = Number(n);
  if(!Number.isFinite(num)) return "";
  return "$" + num.toFixed(2);
}
function parseIntSafe(v, fallback=null){
  const t = clean(v).replace(/[^\d-]/g,"");
  if(!t) return fallback;
  const n = parseInt(t,10);
  return Number.isFinite(n) ? n : fallback;
}
function parsePhotoUrls(text){
  const t = clean(text);
  if(!t) return [];
  return t.split(",").map(s=>clean(s)).filter(Boolean).filter(u=>/^https?:\/\//i.test(u));
}

function setAdminUI(on){
  isAdmin = !!on;
  document.body.classList.toggle("is-admin", isAdmin);
  applyFilters();
}

/* ===== secret logo clicks ===== */
function beeSecret(){
  beeClicks++;
  if(beeClicks===3){
    loginCard.style.display="block";
    setNote(loginMsg, loginMsgText, "Login with your Firebase Auth email/password.", "");
    beeClicks=0;
  }
  setTimeout(()=>beeClicks=0, 900);
}

/* ===== Firebase Auth login/logout ===== */
async function login(){
  const email = clean(username.value);
  const pass  = clean(password.value);

  if(!email || !pass){
    setNote(loginMsg, loginMsgText, "Enter email and password.", "warn");
    return;
  }

  setNote(loginMsg, loginMsgText, "Signing in…", "");
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    loginCard.style.display="none";
    username.value="";
    password.value="";
    showToast("Admin enabled");
  }catch(e){
    setNote(loginMsg, loginMsgText, "Login failed: " + (e?.message || ""), "bad");
    console.error(e);
  }
}
async function logout(){
  try{ await auth.signOut(); }catch(e){ console.error(e); }
  closeEdit();
  closeParts();
  showToast("Admin disabled");
}

/* ===== auth state -> admin UI ===== */
auth.onAuthStateChanged((user)=>{
  setAdminUI(!!user);
});

/* =========================
   STOCK NUMBER (transaction)
   ========================= */
function pad3(n){ return String(n).padStart(3,"0"); }
function yyyymmdd(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}

async function nextStockNumber(){
  const today = yyyymmdd(new Date());

  const stock = await db.runTransaction(async (tx)=>{
    const snap = await tx.get(metaRef);
    let seq = 0;

    if(!snap.exists){
      seq = 1;
      tx.set(metaRef, { date: today, seq: 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }else{
      const data = snap.data() || {};
      const oldDate = clean(data.date);
      const oldSeq = Number(data.seq || 0);

      if(oldDate === today){
        seq = oldSeq + 1;
        tx.update(metaRef, { seq, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }else{
        seq = 1;
        tx.update(metaRef, { date: today, seq: 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    return `TLB-${today}-${pad3(seq)}`;
  });

  return stock;
}

async function generateStockToForm(isEdit){
  const el = isEdit ? document.getElementById("e_stockNumber") : document.getElementById("stockNumber");
  const msgEl = isEdit ? editMsg : adminMsg;
  const msgTextEl = isEdit ? editMsgText : adminMsgText;

  if(!auth.currentUser){
    setNote(msgEl, msgTextEl, "Login first (tap logo 3x). Stock generator requires admin auth.", "warn");
    return;
  }

  try{
    setNote(msgEl, msgTextEl, "Generating Stock #…", "");
    const s = await nextStockNumber();
    el.value = s;
    setNote(msgEl, msgTextEl, `Stock # ready: ${s}`, "ok");
    showToast("Stock # generated");
  }catch(e){
    setNote(msgEl, msgTextEl, "Stock # generator failed: " + (e?.message || "rules/connection"), "bad");
    console.error(e);
  }
}

/* =========================
   VIN AUTO-FILL (VPIC)
   ========================= */
async function decodeVIN(vin){
  const url = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${encodeURIComponent(vin)}?format=json`;
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("VIN lookup failed");
  const j = await r.json();
  const row = j && j.Results && j.Results[0] ? j.Results[0] : null;
  if(!row) throw new Error("No VIN data");

  const year = clean(row.ModelYear);
  const make = clean(row.Make);
  const model = clean(row.Model);

  let engine = "";
  const dispL = clean(row.DisplacementL);
  if(dispL && dispL !== "0") engine = `${dispL}L`;
  else engine = clean(row.EngineModel) || clean(row.EngineCylinders ? `${row.EngineCylinders} Cyl` : "");

  const transmission = clean(row.TransmissionStyle) || clean(row.TransmissionSpeeds ? `${row.TransmissionSpeeds}-Speed` : "");
  const drivetrain = clean(row.DriveType);

  return { year, make, model, engine, transmission, drivetrain };
}

async function autoFillFromVIN(isEdit){
  const vinEl = isEdit ? document.getElementById("e_vin") : document.getElementById("vin");
  const v = cleanVIN(vinEl.value);

  const msgEl = isEdit ? editMsg : adminMsg;
  const msgTextEl = isEdit ? editMsgText : adminMsgText;

  if(!validVIN(v)){
    setNote(msgEl, msgTextEl, "VIN must be 17 chars (no I/O/Q) to auto-fill.", "warn");
    return;
  }

  setNote(msgEl, msgTextEl, "Decoding VIN…", "");
  try{
    const d = await decodeVIN(v);

    const yEl = isEdit ? e_year : year;
    const mkEl = isEdit ? e_make : make;
    const mdEl = isEdit ? e_model : model;
    const engEl = isEdit ? e_engine : engine;
    const trnEl = isEdit ? e_transmission : transmission;
    const drvEl = isEdit ? e_drivetrain : drivetrain;

    if(d.year) yEl.value = d.year;
    if(d.make) mkEl.value = d.make;
    if(d.model) mdEl.value = d.model;

    if(d.engine && !clean(engEl.value)) engEl.value = d.engine;
    if(d.transmission && !clean(trnEl.value)) trnEl.value = d.transmission;
    if(d.drivetrain && !clean(drvEl.value)) drvEl.value = d.drivetrain;

    setNote(msgEl, msgTextEl, `Auto-filled: ${[d.year,d.make,d.model].filter(Boolean).join(" ") || "done"}.`, "ok");
    showToast("VIN Auto-Fill");
  }catch(e){
    setNote(msgEl, msgTextEl, "VIN auto-fill failed: " + (e?.message || "try again"), "bad");
    console.error(e);
  }
}

function hookVinAutoFill(){
  const vinInput = document.getElementById("vin");
  const eVinInput = document.getElementById("e_vin");

  vinInput.addEventListener("input", ()=>{
    const v = cleanVIN(vinInput.value);
    vinInput.value = v;
    if(v.length === 17 && validVIN(v)) autoFillFromVIN(false);
  });

  eVinInput.addEventListener("input", ()=>{
    const v = cleanVIN(eVinInput.value);
    eVinInput.value = v;
    if(v.length === 17 && validVIN(v)) autoFillFromVIN(true);
  });
}

/* =========================
   PHOTO
   ========================= */
function enableDragScroll(el){
  let isDown=false, startX=0, startLeft=0;

  el.addEventListener("mousedown",(e)=>{
    isDown=true;
    startX=e.pageX;
    startLeft=el.scrollLeft;
    el.style.cursor="grabbing";
    e.preventDefault();
  });
  window.addEventListener("mouseup",()=>{ isDown=false; });
  el.addEventListener("mouseleave",()=>{ isDown=false; });
  el.addEventListener("mousemove",(e)=>{
    if(!isDown) return;
    const dx = e.pageX - startX;
    el.scrollLeft = startLeft - dx;
  });

  el.addEventListener("wheel",(e)=>{
    if(Math.abs(e.deltaX) > Math.abs(e.deltaY)) return;
    if(el.scrollWidth <= el.clientWidth) return;
    el.scrollLeft += e.deltaY;
    e.preventDefault();
  }, { passive:false });
}

function openPhoto(carId, idx){
  const arr = __photosByCarId[carId] || [];
  if(!arr.length) return;

  __currentPhoto.carId = carId;
  __currentPhoto.idx = Math.max(0, Math.min(idx, arr.length-1));

  photoBack.style.display = "block";
  setNote(photoMsg, photoMsgText, "Swipe on phone, or use Prev/Next.", "");
  renderPhoto();
}
function renderPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length){ closePhoto(); return; }
  photoView.src = arr[__currentPhoto.idx];
  photoSub.textContent = `Photo ${__currentPhoto.idx+1} of ${arr.length}`;
}
function closePhoto(){
  photoBack.style.display = "none";
  photoView.src = "";
  __currentPhoto = { carId:null, idx:0 };
}
function nextPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  __currentPhoto.idx = (__currentPhoto.idx + 1) % arr.length;
  renderPhoto();
}
function prevPhoto(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  __currentPhoto.idx = (__currentPhoto.idx - 1 + arr.length) % arr.length;
  renderPhoto();
}
function openPhotoInNewTab(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  window.open(arr[__currentPhoto.idx], "_blank");
}
async function copyCurrentPhotoUrl(){
  const arr = __photosByCarId[__currentPhoto.carId] || [];
  if(!arr.length) return;
  await copyText(arr[__currentPhoto.idx]);
  showToast("Photo URL copied");
}
let _swipeX=null;
photoView.addEventListener("touchstart",(e)=>{ _swipeX = e.touches?.[0]?.clientX ?? null; },{passive:true});
photoView.addEventListener("touchend",(e)=>{
  if(_swipeX===null) return;
  const endX = e.changedTouches?.[0]?.clientX ?? null;
  if(endX===null) return;
  const dx = endX - _swipeX;
  _swipeX=null;
  if(Math.abs(dx) < 40) return;
  if(dx < 0) nextPhoto(); else prevPhoto();
},{passive:true});
photoBack.addEventListener("click",(e)=>{ if(e.target===photoBack) closePhoto(); });

/* =========================
   PARTS (PUBLIC READ, ADMIN WRITE)
   ========================= */
function partsCol(carId){ return ref.doc(carId).collection("parts"); }

function closeParts(){
  partsBack.style.display = "none";
  partsSub.textContent = "—";
  partsBody.innerHTML = "";
  partsCount.textContent = "0 parts";
  __partsCarId = null;
  __partsList = [];
  __editingPartId = null;
  resetPartForm();
  partsPublicNote.style.display = "none";
  partsPublicNoteText.textContent = "";
  setNote(partsMsg, partsMsgText, "", "");
  if(__partsUnsub){ __partsUnsub(); __partsUnsub = null; }
}

function openParts(carId){
  if(!carId) return;
  __partsCarId = carId;

  const car = liveCars.find(x=>x.id===carId);
  const stock = clean(car?.stockNumber) || "—";
  const veh = `${clean(car?.year)} ${clean(car?.make)} ${clean(car?.model)}`.trim();

  partsSub.textContent = `${veh || "Vehicle"} • Stock: ${stock}`;
  partsBack.style.display = "block";

  if(!isAdmin){
    partsPublicNote.style.display = "flex";
    partsPublicNoteText.textContent = "View only. (Admin can add/edit/delete parts.)";
    partsPublicNote.className = "note";
  }else{
    partsPublicNote.style.display = "none";
    partsPublicNoteText.textContent = "";
  }

  if(__partsUnsub){ __partsUnsub(); __partsUnsub = null; }

  __partsUnsub = partsCol(carId).orderBy("createdAt","desc").onSnapshot((s)=>{
    __partsList = [];
    s.forEach(doc=>{ __partsList.push({ id: doc.id, ...doc.data() }); });
    partsCount.textContent = `${__partsList.length} part${__partsList.length===1?"":"s"}`;
    renderParts();
  }, (e)=>{
    partsCount.textContent = "Error";
    partsBody.innerHTML = `<tr><td colspan="5" class="muted">Failed to load parts: ${escHtml(e?.message || "rules/connection")}</td></tr>`;
    console.error(e);
  });
}

function refreshParts(){ showToast("Refreshing…"); }

function renderParts(){
  partsBody.innerHTML = "";
  if(!__partsList.length){
    partsBody.innerHTML = `<tr><td colspan="5" class="muted">No parts listed for this vehicle.</td></tr>`;
    return;
  }

  __partsList.forEach(p=>{
    const name = escHtml(p.partName || "Part");
    const type = escHtml(p.partType || "");
    const inter = escHtml(p.interchange || "");
    const loc = escHtml(p.location || "");
    const notes = escHtml(p.notes || "");
    const qty = (typeof p.qty === "number") ? p.qty : (parseIntSafe(p.qty, 1) ?? 1);
    const price = (typeof p.price === "number") ? p.price : parseMoney(p.price);
    const core = (typeof p.core === "number") ? p.core : parseMoney(p.core);

    partsBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div style="font-weight:950">${name}</div>
          <div class="muted">
            ${type ? `${type}` : ``}
            ${type && (inter||loc) ? ` • ` : ``}
            ${inter ? `IC: ${inter}` : ``}
            ${(inter && loc) ? ` • ` : ``}
            ${loc ? `Loc: ${loc}` : ``}
          </div>
          ${notes ? `<div class="muted" style="margin-top:6px">${notes}</div>` : ``}
        </td>
        <td><span class="badgeQty">Qty <span>${qty}</span></span></td>
        <td class="money">${price!==null ? escHtml(fmtMoney(price)) : "—"}</td>
        <td class="money">${core!==null ? escHtml(fmtMoney(core)) : "—"}</td>
        <td>
          ${isAdmin ? `
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="smallBtn primary" onclick="editPart('${p.id}')">Edit</button>
              <button class="smallBtn danger" onclick="deletePart('${p.id}')">Delete</button>
            </div>
          ` : `<div class="muted">View only</div>`}
        </td>
      </tr>
    `);
  });
}

function resetPartForm(){
  if(typeof p_partName === "undefined") return;
  p_partName.value = "";
  p_partType.value = "";
  p_interchange.value = "";
  p_location.value = "";
  p_qty.value = "1";
  p_price.value = "";
  p_core.value = "";
  p_notes.value = "";
  __editingPartId = null;
  p_saveBtn.textContent = "Save Part";
  setNote(partsMsg, partsMsgText, "", "");
}

function editPart(partId){
  if(!isAdmin) return;
  const p = __partsList.find(x=>x.id===partId);
  if(!p) return;

  __editingPartId = partId;
  p_partName.value = p.partName || "";
  p_partType.value = p.partType || "";
  p_interchange.value = p.interchange || "";
  p_location.value = p.location || "";
  p_qty.value = String((typeof p.qty==="number") ? p.qty : (parseIntSafe(p.qty,1) ?? 1));
  p_price.value = (p.price ?? "") !== "" ? String(p.price ?? "") : "";
  p_core.value = (p.core ?? "") !== "" ? String(p.core ?? "") : "";
  p_notes.value = p.notes || "";
  p_saveBtn.textContent = "Update Part";
  setNote(partsMsg, partsMsgText, "Editing part…", "");
  showToast("Editing part");
}

async function savePart(){
  if(!isAdmin || !__partsCarId) return;

  const payload = {
    partName: clean(p_partName.value),
    partType: clean(p_partType.value),
    interchange: clean(p_interchange.value),
    location: clean(p_location.value),
    qty: Math.max(1, parseIntSafe(p_qty.value, 1) || 1),
    notes: clean(p_notes.value)
  };

  const price = parseMoney(p_price.value);
  const core = parseMoney(p_core.value);
  if(price !== null) payload.price = price; else payload.price = firebase.firestore.FieldValue.delete();
  if(core !== null) payload.core = core; else payload.core = firebase.firestore.FieldValue.delete();

  if(!payload.partName){
    setNote(partsMsg, partsMsgText, "Part name required.", "warn");
    showToast("Part name required");
    return;
  }

  try{
    p_saveBtn.disabled = true;
    setNote(partsMsg, partsMsgText, "Saving…", "");

    if(__editingPartId){
      await partsCol(__partsCarId).doc(__editingPartId).update({
        ...payload,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setNote(partsMsg, partsMsgText, "Updated.", "ok");
      showToast("Updated");
    }else{
      await partsCol(__partsCarId).add({
        ...payload,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setNote(partsMsg, partsMsgText, "Added.", "ok");
      showToast("Added part");
    }

    resetPartForm();
  }catch(e){
    setNote(partsMsg, partsMsgText, "Save failed: " + (e?.message || ""), "bad");
    showToast("Save failed");
    console.error(e);
  }finally{
    p_saveBtn.disabled = false;
  }
}

async function deletePart(partId){
  if(!isAdmin || !__partsCarId) return;
  if(!confirm("Delete this part?")) return;

  try{
    await partsCol(__partsCarId).doc(partId).delete();
    showToast("Part deleted");
  }catch(e){
    showToast("Delete failed");
    console.error(e);
  }
}

async function copyPartsCSV(){
  if(!__partsList.length){ showToast("No parts"); return; }

  const rows = [["PartName","PartType","Interchange","Location","Qty","Price","Core","Notes"]];
  __partsList.forEach(p=>{
    rows.push([
      String(p.partName||""),
      String(p.partType||""),
      String(p.interchange||""),
      String(p.location||""),
      String((typeof p.qty==="number")?p.qty:(parseIntSafe(p.qty,1)||1)),
      String((typeof p.price==="number")?p.price:(parseMoney(p.price)||"")),
      String((typeof p.core==="number")?p.core:(parseMoney(p.core)||"")),
      String(p.notes||"")
    ].map(x=>String(x).replace(/"/g,'""')));
  });

  const csv = rows.map(r => `"${r.join('","')}"`).join("\n");
  await copyText(csv);
  showToast("CSV copied");
}

partsBack.addEventListener("click",(e)=>{ if(e.target === partsBack) closeParts(); });

/* =========================
   VEHICLES: add/edit/delete
   ========================= */
async function addCar(){
  if(!auth.currentUser){
    setNote(adminMsg, adminMsgText, "Login first (tap logo 3x).", "warn");
    return;
  }

  const stock = clean(stockNumber.value);
  const y = clean(year.value);
  const mk = clean(make.value);
  const md = clean(model.value);
  const miles = parseMileage(mileage.value);
  const v = cleanVIN(vin.value);
  const col = clean(color.value);
  const eng = clean(engine.value);
  const trn = clean(transmission.value);
  const drv = clean(drivetrain.value);

  const gm = ynToBool(document.getElementById("goodMotor").value);
  const gt = ynToBool(document.getElementById("goodTrans").value);

  const photos = parsePhotoUrls(document.getElementById("photoUrls").value);

  if(!y || !mk || !md){
    setNote(adminMsg, adminMsgText, "Year, Make, and Model are required.", "warn");
    return;
  }
  if(v && !validVIN(v)){
    setNote(adminMsg, adminMsgText, "VIN must be 17 chars (no I/O/Q).", "warn");
    return;
  }

  addBtn.disabled = true;
  setNote(adminMsg, adminMsgText, "Saving…", "");

  try{
    let finalStock = stock;
    if(!finalStock){
      finalStock = await nextStockNumber();
      stockNumber.value = finalStock;
    }

    const payload = {
      stockNumber: finalStock,
      year:y,
      make:mk,
      model:md,
      vin:v,
      color:col,
      engine:eng,
      transmission:trn,
      drivetrain:drv,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if(miles !== null) payload.mileage = miles;
    if(photos.length) payload.photos = photos;

    if(gm !== null) payload.goodMotor = gm;
    if(gt !== null) payload.goodTrans = gt;

    await ref.add(payload);

    document.querySelectorAll('#adminPanel input').forEach(i=>i.value="");
    document.getElementById("goodMotor").value = "";
    document.getElementById("goodTrans").value = "";
    document.getElementById("photoUrls").value = "";

    setNote(adminMsg, adminMsgText, `Vehicle added. Stock #: ${finalStock}`, "ok");
    showToast("Added");

  }catch(e){
    setNote(adminMsg, adminMsgText, "Save failed: " + (e?.message || "rules/connection"), "bad");
    console.error(e);
  }

  addBtn.disabled = false;
}

async function removeCar(id){
  if(!isAdmin) return;
  if(!confirm("Delete this vehicle?")) return;

  try{
    await ref.doc(id).delete();
    showToast("Deleted");
  }catch(e){
    showToast("Delete failed");
    console.error(e);
  }
}

function scrollToAdmin(){
  document.getElementById("adminPanel").scrollIntoView({behavior:"smooth", block:"start"});
}

function openEdit(id){
  if(!isAdmin) return;
  const car = liveCars.find(x=>x.id===id);
  if(!car) return;

  editingId = id;

  e_stockNumber.value = car.stockNumber || "";
  e_year.value = car.year || "";
  e_make.value = car.make || "";
  e_model.value = car.model || "";
  e_mileage.value = (car.mileage ?? "") !== "" ? String(car.mileage ?? "") : "";
  e_vin.value = car.vin || "";
  e_color.value = car.color || "";
  e_engine.value = car.engine || "";
  e_transmission.value = car.transmission || "";
  e_drivetrain.value = car.drivetrain || "";
  e_goodMotor.value = boolToYN(car.goodMotor);
  e_goodTrans.value = boolToYN(car.goodTrans);
  e_photoUrls.value = Array.isArray(car.photos) ? car.photos.join(", ") : "";

  setNote(editMsg, editMsgText, "", "");
  editBack.style.display = "block";
}

function closeEdit(){
  editBack.style.display = "none";
  editingId = null;
  setNote(editMsg, editMsgText, "", "");
}

async function saveEdit(){
  if(!isAdmin || !editingId) return;

  const stock = clean(e_stockNumber.value);
  const y = clean(e_year.value);
  const mk = clean(e_make.value);
  const md = clean(e_model.value);
  const miles = parseMileage(e_mileage.value);
  const v = cleanVIN(e_vin.value);
  const col = clean(e_color.value);
  const eng = clean(e_engine.value);
  const trn = clean(e_transmission.value);
  const drv = clean(e_drivetrain.value);

  const gm = ynToBool(e_goodMotor.value);
  const gt = ynToBool(e_goodTrans.value);

  const photos = parsePhotoUrls(e_photoUrls.value);

  if(!y || !mk || !md){
    setNote(editMsg, editMsgText, "Year, Make, and Model are required.", "warn");
    return;
  }
  if(v && !validVIN(v)){
    setNote(editMsg, editMsgText, "VIN must be 17 chars (no I/O/Q).", "warn");
    return;
  }

  saveBtn.disabled = true;
  setNote(editMsg, editMsgText, "Saving…", "");

  try{
    let finalStock = stock;
    if(!finalStock){
      finalStock = await nextStockNumber();
      e_stockNumber.value = finalStock;
    }

    const updates = {
      stockNumber: finalStock,
      year:y,
      make:mk,
      model:md,
      vin:v,
      color:col,
      engine:eng,
      transmission:trn,
      drivetrain:drv
    };

    if(miles === null) updates.mileage = firebase.firestore.FieldValue.delete();
    else updates.mileage = miles;

    if(!photos.length) updates.photos = firebase.firestore.FieldValue.delete();
    else updates.photos = photos;

    updates.goodMotor = (gm === null) ? firebase.firestore.FieldValue.delete() : gm;
    updates.goodTrans = (gt === null) ? firebase.firestore.FieldValue.delete() : gt;

    await ref.doc(editingId).update(updates);

    setNote(editMsg, editMsgText, "Saved.", "ok");
    showToast("Saved");
    setTimeout(closeEdit, 450);

  }catch(e){
    setNote(editMsg, editMsgText, "Save failed: " + (e?.message || "rules/connection"), "bad");
    console.error(e);
  }

  saveBtn.disabled = false;
}

async function deleteFromEdit(){
  if(!isAdmin || !editingId) return;
  if(!confirm("Delete this vehicle?")) return;

  try{
    await ref.doc(editingId).delete();
    showToast("Deleted");
    closeEdit();
  }catch(e){
    showToast("Delete failed");
    console.error(e);
  }
}

editBack.addEventListener("click",(e)=>{ if(e.target === editBack) closeEdit(); });
document.addEventListener("keydown",(e)=>{
  if(e.key === "Escape"){
    closeEdit();
    closePhoto();
    closeParts();
  }
});

/* ===== live render with snapshot ===== */
function startListener(){
  if(unsub) unsub();

  setNote(invMsg, invMsgText, "Loading inventory…", "");
  countLine.textContent = "Loading…";
  liveHint.textContent = "Connecting…";

  unsub = ref.orderBy("createdAt","desc").onSnapshot(s=>{
    liveCars = [];
    s.forEach(doc=>{ liveCars.push({ id: doc.id, ...doc.data() }); });

    countLine.textContent = `${liveCars.length} vehicles`;
    liveHint.textContent = "Live sync on";
    setNote(invMsg, invMsgText, liveCars.length ? "Tap Stock/VIN to copy. Click Parts to view parts." : "No vehicles yet.", liveCars.length ? "" : "warn");
    applyFilters();
  }, (err)=>{
    setNote(invMsg, invMsgText, "Live sync failed: " + (err?.message || "rules/connection"), "bad");
    countLine.textContent = "Error";
    liveHint.textContent = "Offline";
    console.error(err);
  });
}

/* ===== filters/sort ===== */
function applyFilters(){
  const q = clean(searchEl.value).toLowerCase();
  const sort = sortEl.value;

  let list = liveCars.slice();

  list.forEach(c=>{
    c._ts = getMs(c.createdAt);
    c._miles = (typeof c.mileage === "number") ? c.mileage : (parseMileage(String(c.mileage||"")) ?? null);
  });

  if(q){
    list = list.filter(c=>{
      const blob = [
        c.stockNumber,
        c.year, c.make, c.model, c.vin, c.color, c.engine, c.transmission, c.drivetrain,
        c.mileage,
        (c.goodMotor===true ? "good motor" : c.goodMotor===false ? "bad motor" : ""),
        (c.goodTrans===true ? "good transmission" : c.goodTrans===false ? "bad transmission" : "")
      ].map(x=>String(x||"").toLowerCase()).join(" ");
      return blob.includes(q);
    });
  }

  list.sort((a,b)=>{
    const ay = parseInt(a.year||"0",10) || 0;
    const by = parseInt(b.year||"0",10) || 0;
    const am = a._miles ?? 9e15;
    const bm = b._miles ?? 9e15;

    if(sort==="newest") return (b._ts||0) - (a._ts||0);
    if(sort==="oldest") return (a._ts||0) - (b._ts||0);
    if(sort==="yearDesc") return by - ay;
    if(sort==="yearAsc") return ay - by;
    if(sort==="makeAsc") return String(a.make||"").localeCompare(String(b.make||""));
    if(sort==="milesAsc") return am - bm;
    if(sort==="milesDesc") return bm - am;
    return 0;
  });

  renderTable(list);
  document.querySelectorAll(".photoTrack").forEach(enableDragScroll);
}

function getMs(t){
  try{
    if(!t) return 0;
    if(typeof t.toMillis === "function") return t.toMillis();
    return 0;
  }catch{return 0;}
}

function ynLabel(b, what){
  if(b===true) return `${what}: Good ✅`;
  if(b===false) return `${what}: Bad ❌`;
  return "";
}

function buildPhotoSquare(carId, photos){
  const arr = Array.isArray(photos) ? photos.filter(Boolean) : [];
  __photosByCarId[carId] = arr;

  if(!arr.length){
    return `
      <div class="photoSquare">
        <div class="photoFallback">NO PHOTOS</div>
      </div>
    `;
  }

  const imgs = arr.map((u,i)=>{
    const safe = escHtml(u);
    return `<img src="${safe}" alt="Vehicle photo" loading="lazy" onclick="openPhoto('${carId}', ${i})" onerror="this.style.display='none'">`;
  }).join("");

  return `
    <div class="photoSquare hasPhotos">
      <div class="photoBadge"><span>${arr.length}</span> photo${arr.length===1?"":"s"}</div>
      <div class="photoTrack" aria-label="Vehicle photos">
        ${imgs}
      </div>
    </div>
  `;
}

function renderTable(list){
  inventoryBody.innerHTML = "";

  list.forEach(c=>{
    const vehicleLine = `${escHtml(c.year||"")} ${escHtml(c.make||"")} ${escHtml(c.model||"")}`.trim() || "Vehicle";
    const vinVal = escHtml(c.vin||"");
    const stockVal = escHtml(c.stockNumber||"");

    const specsArr = [c.color, c.engine, c.transmission, c.drivetrain].filter(Boolean).map(escHtml);
    const gmText = ynLabel(c.goodMotor, "Motor");
    const gtText = ynLabel(c.goodTrans, "Trans");
    if(gmText) specsArr.push(escHtml(gmText));
    if(gtText) specsArr.push(escHtml(gtText));
    const specs = specsArr.join(" · ");

    const tags = [];
    const milesLabel = fmtMiles(c.mileage);
    if(stockVal) tags.push(`<span class="tag stock">Stock: ${stockVal}</span>`);
    if(milesLabel) tags.push(`<span class="tag miles">${escHtml(milesLabel)}</span>`);
    if(c.drivetrain) tags.push(`<span class="tag">${escHtml(c.drivetrain)}</span>`);
    if(c.transmission) tags.push(`<span class="tag">${escHtml(c.transmission)}</span>`);
    if(c.engine) tags.push(`<span class="tag">${escHtml(c.engine)}</span>`);
    if(c.goodMotor===true) tags.push(`<span class="tag ok">Good Motor ✅</span>`);
    if(c.goodMotor===false) tags.push(`<span class="tag bad">Bad Motor ❌</span>`);
    if(c.goodTrans===true) tags.push(`<span class="tag ok">Good Trans ✅</span>`);
    if(c.goodTrans===false) tags.push(`<span class="tag bad">Bad Trans ❌</span>`);

    const photoSquare = buildPhotoSquare(c.id, c.photos);

    inventoryBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div class="gallery">
            ${photoSquare}
            <div style="min-width:0">
              <strong>${vehicleLine}</strong>
              ${specs ? `<div class="specs">${specs}</div>` : ``}
              ${tags.length ? `<div class="kv">${tags.join("")}</div>` : ``}
            </div>
          </div>
        </td>

        <td>
          <div class="copyLine">
            ${stockVal ? `<button class="smallBtn" onclick="copyText('${stockVal}')">Copy Stock</button>` : ``}
            ${vinVal ? `<button class="smallBtn ghost" onclick="copyText('${vinVal}')">Copy VIN</button>` : ``}
            <button class="smallBtn" onclick="openParts('${c.id}')">Parts</button>
            ${vinVal ? `<button class="smallBtn ghost" onclick="copyText('${vehicleLine} • ${vinVal}')">Copy Line</button>` : ``}
          </div>
          <div class="specs" style="margin-top:8px">
            ${stockVal ? `<div><strong>Stock:</strong> ${stockVal}</div>` : `<div>Stock: —</div>`}
            ${vinVal ? `<div><strong>VIN:</strong> ${vinVal}</div>` : `<div>VIN: —</div>`}
          </div>
        </td>

        <td class="admin-only admin-cell">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="smallBtn primary" onclick="openEdit('${c.id}')">Edit</button>
            <button class="smallBtn" onclick="openParts('${c.id}')">Parts</button>
            <button class="smallBtn danger" onclick="removeCar('${c.id}')">Delete</button>
          </div>
        </td>
      </tr>
    `);
  });
}

async function copyText(t){
  try{
    await navigator.clipboard.writeText(t);
    showToast("Copied");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied");
  }
}

function clearSearch(){
  searchEl.value = "";
  applyFilters();
}

/* init */
(function init(){
  hookVinAutoFill();
  startListener();
  setNote(invMsg, invMsgText, "Loading inventory…", "");
  setNote(loginMsg, loginMsgText, "", "");
  setNote(adminMsg, adminMsgText, "", "");
})();
</script>

</body>
</html>


